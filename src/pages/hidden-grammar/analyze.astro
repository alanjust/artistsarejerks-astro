---
import BaseLayout from '../../layouts/BaseLayout.astro';
import modes from '../../data/hg-modes.json';
import roots from '../../data/hg-roots.json';
import principles from '../../data/hg-principles.json';

const strategicMode = modes.modes.find(m => m.id === 'strategic');
---

<BaseLayout title="Hidden Grammar Analysis">
  <div class="analyze-page">
    <header class="analyze-header">
      <h1>Art Analysis Tool</h1>
      <p class="subtitle">Strategic Mode: The Standard Critique</p>
    </header>

    <div class="analyze-container">
      <!-- Left Panel: Image Upload & Info -->
      <aside class="image-panel">
        <div class="upload-section">
          <h2>Upload Artwork</h2>
          <div class="upload-area" id="uploadArea">
            <svg class="upload-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor">
              <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4M17 8l-5-5-5 5M12 3v12"/>
            </svg>
            <p class="upload-text">Click to upload or drag & drop</p>
            <p class="upload-hint">JPG, PNG, WebP up to 10MB</p>
            <input type="file" id="imageInput" accept="image/*" hidden>
          </div>

          <div class="image-preview-container" id="imagePreviewContainer" style="display: none;">
            <img id="imagePreview" alt="Uploaded artwork">
            <button class="remove-image" id="removeImage">× Remove</button>
          </div>
        </div>

        <div class="artwork-metadata">
          <h3>Artwork Details</h3>
          <div class="form-group">
            <label for="artworkTitle">Title</label>
            <input type="text" id="artworkTitle" placeholder="e.g., Starry Night">
          </div>
          <div class="form-group">
            <label for="artistName">Artist</label>
            <input type="text" id="artistName" placeholder="e.g., Vincent van Gogh">
          </div>
          <div class="form-group">
            <label for="yearCreated">Year (optional)</label>
            <input type="text" id="yearCreated" placeholder="e.g., 1889">
          </div>
          <div class="form-group">
            <label for="medium">Medium (optional)</label>
            <input type="text" id="medium" placeholder="e.g., Oil on canvas">
          </div>
        </div>

        <div class="mode-info">
          <h3>About Strategic Mode</h3>
          <p>{strategicMode?.description}</p>
          <div class="mode-steps">
            <h4>Analysis Steps:</h4>
            <ol>
              {strategicMode?.steps?.map(step => (
                <li>{step}</li>
              ))}
            </ol>
          </div>
        </div>
      </aside>

      <!-- Right Panel: Analysis Form -->
      <main class="analysis-panel">
        <div class="analysis-form" id="analysisForm">

          <!-- Section 1: Primary Action -->
          <section class="form-section" data-section="1">
            <div class="section-header">
              <span class="section-number">1</span>
              <h2>Primary Action</h2>
            </div>
            <p class="section-description">What is this work primarily doing?</p>

            <div class="action-selector">
              <label class="action-option">
                <input type="radio" name="primaryAction" value="stripping">
                <div class="action-card">
                  <h3>Stripping</h3>
                  <p class="mechanism">Mechanism: Peak Shift</p>
                  <p>Reducing to essentials. Simplified forms, minimal detail, geometric reduction.</p>
                </div>
              </label>

              <label class="action-option">
                <input type="radio" name="primaryAction" value="building">
                <div class="action-card">
                  <h3>Building</h3>
                  <p class="mechanism">Mechanism: Mirror Neurons</p>
                  <p>Adding sensory richness. Heavy impasto, visible brushwork, tactile surfaces.</p>
                </div>
              </label>

              <label class="action-option">
                <input type="radio" name="primaryAction" value="holding">
                <div class="action-card">
                  <h3>Holding</h3>
                  <p class="mechanism">Mechanism: Freeze Response</p>
                  <p>Sustaining tension. Contradictory elements, uncomfortable relationships, refusal to resolve.</p>
                </div>
              </label>

              <label class="action-option">
                <input type="radio" name="primaryAction" value="integrating">
                <div class="action-card">
                  <h3>Integrating</h3>
                  <p class="mechanism">Mechanism: Gamma Synchrony</p>
                  <p>Achieving wholeness. Disparate elements click into coherent gestalt.</p>
                </div>
              </label>
            </div>
          </section>

          <!-- Section 2: Visual Observations -->
          <section class="form-section" data-section="2">
            <div class="section-header">
              <span class="section-number">2</span>
              <h2>Raw Observations</h2>
              <span class="section-badge">Evidence-First</span>
            </div>
            <p class="section-description">List what you literally see. No interpretation, no meaning, no judgment.</p>

            <div class="form-group">
              <label for="observations">
                Visual Inventory
                <span class="help-text">Examples: "High contrast edges in center", "Blue dominates upper third", "Thick paint texture visible"</span>
              </label>
              <textarea id="observations" rows="8" placeholder="- Observation 1&#10;- Observation 2&#10;- Observation 3&#10;..."></textarea>
            </div>

            <div class="form-group">
              <label for="snags">
                Attention Snags
                <span class="help-text">Where does your eye get stuck? What creates friction?</span>
              </label>
              <textarea id="snags" rows="4" placeholder="Describe 2-3 places where attention locks or hesitates..."></textarea>
            </div>

            <div class="form-group">
              <label for="slides">
                Attention Slides
                <span class="help-text">Where does attention glide without resistance?</span>
              </label>
              <textarea id="slides" rows="3" placeholder="Describe areas that are easy to scan past..."></textarea>
            </div>
          </section>

          <!-- Section 3: Principle Mapping -->
          <section class="form-section" data-section="3">
            <div class="section-header">
              <span class="section-number">3</span>
              <h2>Principle Mapping</h2>
              <span class="section-badge">Mechanisms</span>
            </div>
            <p class="section-description">Map your observations to perceptual mechanisms. Select 3-5 principles that are clearly at work.</p>

            <div class="principles-grid">
              {principles.principles
                .filter(p => p.tier === 'A')
                .map(principle => (
                  <label class="principle-checkbox">
                    <input type="checkbox" name="principles" value={principle.id} data-tier={principle.tier}>
                    <div class="principle-label">
                      <strong>{principle.name}</strong>
                      <span class="tier-badge tier-{principle.tier.toLowerCase()}">Tier {principle.tier}</span>
                      <p class="principle-subtitle">{principle.subtitle}</p>
                    </div>
                  </label>
                ))
              }
            </div>

            <details class="more-principles">
              <summary>Show Tier B & C Principles</summary>
              <div class="principles-grid">
                {principles.principles
                  .filter(p => p.tier === 'B' || p.tier === 'C')
                  .map(principle => (
                    <label class="principle-checkbox">
                      <input type="checkbox" name="principles" value={principle.id} data-tier={principle.tier}>
                      <div class="principle-label">
                        <strong>{principle.name}</strong>
                        <span class="tier-badge tier-{principle.tier.toLowerCase()}">Tier {principle.tier}</span>
                        <p class="principle-subtitle">{principle.subtitle}</p>
                      </div>
                    </label>
                  ))
                }
              </div>
            </details>

            <div class="form-group" style="margin-top: var(--space-l);">
              <label for="principleNotes">
                How Principles Connect to Observations
                <span class="help-text">For each selected principle, cite specific observations</span>
              </label>
              <textarea id="principleNotes" rows="6" placeholder="Example:&#10;Edge Detection - The sharp value shift between foreground and background (from observation #3) creates maximum neural activation..."></textarea>
            </div>
          </section>

          <!-- Section 4: Root Hypothesis -->
          <section class="form-section" data-section="4">
            <div class="section-header">
              <span class="section-number">4</span>
              <h2>Root Hypothesis</h2>
              <span class="section-badge warning">RAP-Gated</span>
            </div>
            <p class="section-description">Based on redundant mechanisms, which Roots (Drivers) are operating? Select up to 2.</p>

            <div class="evidence-gate" id="evidenceGate">
              <p class="gate-status">⚠️ Evidence Gate: <strong>Locked</strong></p>
              <p class="gate-requirement">Requirements: 3+ principles mapped with supporting observations</p>
            </div>

            <div class="roots-grid" id="rootsGrid">
              {roots.roots.map(root => (
                <label class="root-checkbox">
                  <input type="checkbox" name="roots" value={root.id} disabled>
                  <div class="root-label">
                    <strong>{root.name}</strong>
                    <span class="root-subtitle">{root.subtitle}</span>
                    <p>{root.governs}</p>
                  </div>
                </label>
              ))}
            </div>

            <div class="form-group">
              <label for="rootEvidence">
                Evidence for Root Claims
                <span class="help-text">For each selected Root, cite 2 pieces of supporting evidence from earlier sections</span>
              </label>
              <textarea id="rootEvidence" rows="6" placeholder="Root 1: [Name]&#10;Evidence A: ...&#10;Evidence B: ...&#10;&#10;Root 2: [Name]&#10;Evidence A: ...&#10;Evidence B: ..."></textarea>
            </div>
          </section>

          <!-- Section 5: Transmission & Friction -->
          <section class="form-section" data-section="5">
            <div class="section-header">
              <span class="section-number">5</span>
              <h2>Transmission Risk & Friction</h2>
            </div>

            <div class="form-group">
              <label for="transmissionRisk">
                How might viewers misread this?
                <span class="help-text">What predictive coding errors could occur?</span>
              </label>
              <textarea id="transmissionRisk" rows="4" placeholder="Non-expert viewers might think... because..."></textarea>
            </div>

            <div class="form-group">
              <label for="frictionLevel">Friction Level</label>
              <div class="friction-slider">
                <input type="range" id="frictionLevel" min="0" max="10" value="5">
                <div class="friction-labels">
                  <span>0 - Kinkade (Zero Friction)</span>
                  <span id="frictionValue">5</span>
                  <span>10 - Twombly (High Friction)</span>
                </div>
              </div>
            </div>

            <div class="form-group">
              <label for="hook">
                The Hook
                <span class="help-text">What specific element stops the eye from "scanning and banning"?</span>
              </label>
              <textarea id="hook" rows="3" placeholder="The element that arrests attention and prevents disengagement..."></textarea>
            </div>
          </section>

          <!-- Section 6: Verdict -->
          <section class="form-section" data-section="6">
            <div class="section-header">
              <span class="section-number">6</span>
              <h2>Verdict & Recommendation</h2>
            </div>

            <div class="form-group">
              <label>Honest or Dishonest?</label>
              <div class="verdict-options">
                <label class="verdict-option">
                  <input type="radio" name="verdict" value="honest">
                  <div class="verdict-card honest">
                    <h4>Honest (High Friction)</h4>
                    <p>Work creates productive tension, disrupts viewer prediction, earns attention</p>
                  </div>
                </label>
                <label class="verdict-option">
                  <input type="radio" name="verdict" value="dishonest">
                  <div class="verdict-card dishonest">
                    <h4>Dishonest (Zero Friction)</h4>
                    <p>Work offers bypass, perceptual fluency without depth, Kinkade effect</p>
                  </div>
                </label>
                <label class="verdict-option">
                  <input type="radio" name="verdict" value="unclear">
                  <div class="verdict-card unclear">
                    <h4>Unclear</h4>
                    <p>Insufficient evidence or mixed signals</p>
                  </div>
                </label>
              </div>
            </div>

            <div class="form-group">
              <label for="justification">
                Justification
                <span class="help-text">Cite observations and principles that support your verdict</span>
              </label>
              <textarea id="justification" rows="4" placeholder="This verdict is supported by..."></textarea>
            </div>

            <div class="form-group">
              <label for="oneMove">
                The ONE Clarifying Move
                <span class="help-text">What single change would strengthen the work's intent?</span>
              </label>
              <textarea id="oneMove" rows="4" placeholder="To clarify the intent, the artist should..."></textarea>
            </div>
          </section>

          <!-- Action Buttons -->
          <div class="form-actions">
            <button type="button" class="btn-secondary" id="saveProgress">Save Progress</button>
            <button type="button" class="btn-primary" id="generateAnalysis">Generate Analysis Report</button>
          </div>
        </div>

        <!-- Results Panel (Hidden initially) -->
        <div class="results-panel" id="resultsPanel" style="display: none;">
          <div class="results-header">
            <h2>Analysis Complete</h2>
            <button class="btn-secondary" id="backToForm">← Edit Analysis</button>
          </div>
          <div class="results-content" id="resultsContent">
            <!-- Generated analysis will appear here -->
          </div>
          <div class="results-actions">
            <button class="btn-primary" id="exportMarkdown">Export as Markdown</button>
            <button class="btn-secondary" id="copyToClipboard">Copy to Clipboard</button>
          </div>
        </div>
      </main>
    </div>
  </div>
</BaseLayout>

<script define:vars={{ principlesJson: principles.principles, rootsJson: roots.roots }}>
  // Image Upload Handling
  const uploadArea = document.getElementById('uploadArea');
  const imageInput = document.getElementById('imageInput');
  const imagePreviewContainer = document.getElementById('imagePreviewContainer');
  const imagePreview = document.getElementById('imagePreview');
  const removeImage = document.getElementById('removeImage');

  uploadArea?.addEventListener('click', () => imageInput?.click());

  uploadArea?.addEventListener('dragover', (e) => {
    e.preventDefault();
    uploadArea.classList.add('dragover');
  });

  uploadArea?.addEventListener('dragleave', () => {
    uploadArea.classList.remove('dragover');
  });

  uploadArea?.addEventListener('drop', (e) => {
    e.preventDefault();
    uploadArea.classList.remove('dragover');
    const file = e.dataTransfer?.files[0];
    if (file && file.type.startsWith('image/')) {
      handleImageUpload(file);
    }
  });

  imageInput?.addEventListener('change', (e) => {
    const file = e.target.files?.[0];
    if (file) {
      handleImageUpload(file);
    }
  });

  removeImage?.addEventListener('click', () => {
    if (imageInput) imageInput.value = '';
    if (imagePreview) imagePreview.src = '';
    if (uploadArea) uploadArea.style.display = 'flex';
    if (imagePreviewContainer) imagePreviewContainer.style.display = 'none';
  });

  function handleImageUpload(file) {
    const reader = new FileReader();
    reader.onload = (e) => {
      if (imagePreview && e.target?.result) {
        imagePreview.src = e.target.result;
        if (uploadArea) uploadArea.style.display = 'none';
        if (imagePreviewContainer) imagePreviewContainer.style.display = 'block';
      }
    };
    reader.readAsDataURL(file);
  }

  // Evidence Gate Logic
  const principleCheckboxes = document.querySelectorAll('input[name="principles"]');
  const principleNotes = document.getElementById('principleNotes');
  const evidenceGate = document.getElementById('evidenceGate');
  const rootCheckboxes = document.querySelectorAll('input[name="roots"]');

  function checkEvidenceGate() {
    const selectedPrinciples = Array.from(principleCheckboxes).filter((cb) => cb.checked).length;
    const hasNotes = principleNotes?.value.trim().length > 50;

    const gateOpen = selectedPrinciples >= 3 && hasNotes;

    if (evidenceGate) {
      const status = evidenceGate.querySelector('.gate-status');
      if (status) {
        if (gateOpen) {
          status.innerHTML = '✅ Evidence Gate: <strong>Passed</strong>';
          evidenceGate.classList.add('open');
          evidenceGate.classList.remove('closed');
        } else {
          status.innerHTML = '⚠️ Evidence Gate: <strong>Locked</strong>';
          evidenceGate.classList.add('closed');
          evidenceGate.classList.remove('open');
        }
      }
    }

    rootCheckboxes.forEach((cb) => {
      cb.disabled = !gateOpen;
    });
  }

  principleCheckboxes.forEach(cb => cb.addEventListener('change', checkEvidenceGate));
  principleNotes?.addEventListener('input', checkEvidenceGate);

  // Friction Slider
  const frictionLevel = document.getElementById('frictionLevel');
  const frictionValue = document.getElementById('frictionValue');

  frictionLevel?.addEventListener('input', (e) => {
    if (frictionValue) {
      frictionValue.textContent = (e.target).value;
    }
  });

  // Generate Analysis
  const generateBtn = document.getElementById('generateAnalysis');
  const resultsPanel = document.getElementById('resultsPanel');
  const analysisForm = document.getElementById('analysisForm');
  const resultsContent = document.getElementById('resultsContent');
  const backToForm = document.getElementById('backToForm');

  generateBtn?.addEventListener('click', () => {
    console.log('Generate button clicked');
    console.log('Title input:', document.getElementById('artworkTitle'));
    console.log('Title value:', document.getElementById('artworkTitle')?.value);
    const analysis = generateAnalysisReport();
    console.log('Analysis generated:', analysis.substring(0, 200));
    if (resultsContent) resultsContent.innerHTML = analysis;
    if (analysisForm) analysisForm.style.display = 'none';
    if (resultsPanel) resultsPanel.style.display = 'block';
    window.scrollTo(0, 0);
  });

  backToForm?.addEventListener('click', () => {
    if (analysisForm) analysisForm.style.display = 'block';
    if (resultsPanel) resultsPanel.style.display = 'none';
    window.scrollTo(0, 0);
  });

  // Store values in data attributes to work around Safari Shadow DOM issues
  // Use document-level event listeners with capture phase to catch events from Shadow DOM
  const formInputs = document.querySelectorAll('input[type="text"], textarea');
  console.log('Found form inputs:', formInputs.length);

  // Set up global capture listener that works even with Shadow DOM
  document.addEventListener('input', (e) => {
    const target = e.target;
    if (target && target.id && (target.tagName === 'INPUT' || target.tagName === 'TEXTAREA')) {
      target.dataset.storedValue = target.value || '';
      console.log('Global input for', target.id, ':', target.value);
    }
  }, true); // Use capture phase to catch Shadow DOM events

  // Initialize stored values
  formInputs.forEach(input => {
    console.log('Setting up listeners for:', input.id);
    input.dataset.storedValue = input.value || '';
  });

  // Helper function to get value from input/textarea
  function getValue(element) {
    if (!element) return '';

    // Always use stored value first (works around Safari Shadow DOM)
    if (element.dataset.storedValue !== undefined) {
      return element.dataset.storedValue;
    }

    // Fallback to regular value
    return element.value || '';
  }

  function generateAnalysisReport() {
    const title = getValue(document.getElementById('artworkTitle')) || 'Untitled';
    const artist = getValue(document.getElementById('artistName')) || 'Unknown Artist';
    const year = getValue(document.getElementById('yearCreated'));
    const medium = getValue(document.getElementById('medium'));

    const primaryAction = document.querySelector('input[name="primaryAction"]:checked')?.value || 'Not specified';

    const observations = getValue(document.getElementById('observations'));
    const snags = getValue(document.getElementById('snags'));
    const slides = getValue(document.getElementById('slides'));

    console.log('Primary Action:', primaryAction);
    console.log('Observations:', observations);
    console.log('Snags:', snags);
    console.log('Slides:', slides);

    const selectedPrinciples = Array.from(document.querySelectorAll('input[name="principles"]:checked'))
      .map((cb) => {
        const id = parseInt(cb.value);
        const principle = window.principlesData?.find((p) => p.id === id);
        return principle ? `${principle.name} (${principle.subtitle})` : `Principle #${id}`;
      });

    const principleNotes = getValue(document.getElementById('principleNotes'));

    const selectedRoots = Array.from(document.querySelectorAll('input[name="roots"]:checked'))
      .map((cb) => {
        const id = cb.value;
        const root = window.rootsData?.find((r) => r.id === id);
        return root ? `${root.name} (${root.subtitle})` : id;
      });

    const rootEvidence = getValue(document.getElementById('rootEvidence'));
    const transmissionRisk = getValue(document.getElementById('transmissionRisk'));
    const frictionLevel = getValue(document.getElementById('frictionLevel'));
    const hook = getValue(document.getElementById('hook'));
    const verdict = document.querySelector('input[name="verdict"]:checked')?.value || 'Not specified';
    const justification = getValue(document.getElementById('justification'));
    const oneMove = getValue(document.getElementById('oneMove'));

    return `
      <div class="report">
        <h1>Hidden Grammar Analysis</h1>
        <div class="report-meta">
          <p><strong>Mode:</strong> Strategic (Standard Critique)</p>
          <p><strong>Date:</strong> ${new Date().toLocaleDateString()}</p>
        </div>

        <div class="report-section">
          <h2>Artwork Information</h2>
          <p><strong>Title:</strong> ${title}</p>
          <p><strong>Artist:</strong> ${artist}</p>
          ${year ? `<p><strong>Year:</strong> ${year}</p>` : ''}
          ${medium ? `<p><strong>Medium:</strong> ${medium}</p>` : ''}
        </div>

        <div class="report-section">
          <h2>1. Primary Action</h2>
          <p class="action-result">${primaryAction.charAt(0).toUpperCase() + primaryAction.slice(1)}</p>
        </div>

        <div class="report-section">
          <h2>2. Raw Observations</h2>
          <h3>Visual Inventory:</h3>
          <pre>${observations || 'No observations recorded'}</pre>

          <h3>Attention Snags:</h3>
          <pre>${snags || 'None noted'}</pre>

          <h3>Attention Slides:</h3>
          <pre>${slides || 'None noted'}</pre>
        </div>

        <div class="report-section">
          <h2>3. Principle Mapping</h2>
          <p><strong>Selected Principles:</strong></p>
          <ul>
            ${selectedPrinciples.map(p => `<li>${p}</li>`).join('')}
          </ul>

          <h3>Connection to Observations:</h3>
          <pre>${principleNotes || 'No connections documented'}</pre>
        </div>

        <div class="report-section">
          <h2>4. Root Hypothesis</h2>
          <p><strong>Active Roots:</strong></p>
          <ul>
            ${selectedRoots.length > 0 ? selectedRoots.map(r => `<li>${r}</li>`).join('') : '<li>No roots selected</li>'}
          </ul>

          <h3>Evidence:</h3>
          <pre>${rootEvidence || 'No evidence provided'}</pre>
        </div>

        <div class="report-section">
          <h2>5. Transmission & Friction Analysis</h2>
          <h3>Transmission Risk:</h3>
          <pre>${transmissionRisk || 'Not assessed'}</pre>

          <h3>Friction Level:</h3>
          <p><strong>${frictionLevel}/10</strong> ${frictionLevel < 3 ? '(Kinkade territory)' : frictionLevel > 7 ? '(Twombly territory)' : '(Moderate friction)'}</p>

          <h3>The Hook:</h3>
          <pre>${hook || 'Not identified'}</pre>
        </div>

        <div class="report-section">
          <h2>6. Verdict</h2>
          <p class="verdict-result ${verdict}">${verdict.charAt(0).toUpperCase() + verdict.slice(1)}</p>

          <h3>Justification:</h3>
          <pre>${justification || 'No justification provided'}</pre>

          <h3>The ONE Clarifying Move:</h3>
          <pre>${oneMove || 'No recommendation provided'}</pre>
        </div>

        <div class="report-footer">
          <p><em>All claims above are interpretive hypotheses based on observable visual evidence, not definitive statements of artist intent.</em></p>
        </div>
      </div>
    `;
  }

  // Export as Markdown
  const exportBtn = document.getElementById('exportMarkdown');
  exportBtn?.addEventListener('click', () => {
    const title = document.getElementById('artworkTitle')?.value || 'Untitled';
    const markdown = generateMarkdownReport();
    const blob = new Blob([markdown], { type: 'text/markdown' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `hidden-grammar-analysis-${title.toLowerCase().replace(/\s/g, '-')}.md`;
    a.click();
    URL.revokeObjectURL(url);
  });

  function generateMarkdownReport() {
    const title = getValue(document.getElementById('artworkTitle')) || 'Untitled';
    const artist = getValue(document.getElementById('artistName')) || 'Unknown Artist';
    const year = getValue(document.getElementById('yearCreated'));
    const medium = getValue(document.getElementById('medium'));
    const primaryAction = document.querySelector('input[name="primaryAction"]:checked')?.value || 'Not specified';
    const observations = getValue(document.getElementById('observations'));
    const verdict = document.querySelector('input[name="verdict"]:checked')?.value || 'Not specified';

    return `# Hidden Grammar Analysis

**Mode:** Strategic (Standard Critique)
**Date:** ${new Date().toLocaleDateString()}

## Artwork Information

- **Title:** ${title}
- **Artist:** ${artist}
${year ? `- **Year:** ${year}\n` : ''}${medium ? `- **Medium:** ${medium}\n` : ''}

## 1. Primary Action

${primaryAction.charAt(0).toUpperCase() + primaryAction.slice(1)}

## 2. Raw Observations

${observations || 'No observations recorded'}

## 3. Principle Mapping

[Principles listed here]

## 4. Root Hypothesis

[Roots and evidence listed here]

## 5. Transmission & Friction Analysis

[Analysis details here]

## 6. Verdict

**${verdict.charAt(0).toUpperCase() + verdict.slice(1)}**

[Justification and recommendations here]

---

*All claims above are interpretive hypotheses based on observable visual evidence, not definitive statements of artist intent.*
`;
  }

  // Make data available globally for report generation
  const principlesData = [
    ...principlesJson
  ];
  const rootsData = [
    ...rootsJson
  ];
  window.principlesData = principlesData;
  window.rootsData = rootsData;

  // Copy to Clipboard
  const copyBtn = document.getElementById('copyToClipboard');
  copyBtn?.addEventListener('click', () => {
    const markdown = generateMarkdownReport();
    navigator.clipboard.writeText(markdown).then(() => {
      alert('Analysis copied to clipboard!');
    });
  });

  // Save Progress (localStorage)
  const saveBtn = document.getElementById('saveProgress');
  saveBtn?.addEventListener('click', () => {
    const formData = {
      title: getValue(document.getElementById('artworkTitle')),
      artist: getValue(document.getElementById('artistName')),
      year: getValue(document.getElementById('yearCreated')),
      medium: getValue(document.getElementById('medium')),
      primaryAction: document.querySelector('input[name="primaryAction"]:checked')?.value,
      observations: getValue(document.getElementById('observations')),
      // Add more fields as needed
    };
    localStorage.setItem('hg-analysis-draft', JSON.stringify(formData));
    alert('Progress saved!');
  });

  // Load saved progress on page load
  window.addEventListener('load', () => {
    const saved = localStorage.getItem('hg-analysis-draft');
    if (saved) {
      try {
        const data = JSON.parse(saved);
        if (data.title) document.getElementById('artworkTitle').value = data.title;
        if (data.artist) document.getElementById('artistName').value = data.artist;
        // Restore other fields...
      } catch (e) {
        console.error('Failed to load saved progress', e);
      }
    }
  });
</script>

<style>
  .analyze-page {
    max-width: 1600px;
    margin: 0 auto;
    padding: var(--space-l);
  }

  .analyze-header {
    text-align: center;
    margin-bottom: var(--space-2xl);
  }

  .analyze-header h1 {
    font-family: var(--font-display);
    font-size: var(--text-4xl);
    color: var(--color-orange);
    margin-bottom: var(--space-s);
  }

  .subtitle {
    font-size: var(--text-xl);
    color: var(--color-gray-6);
  }

  .analyze-container {
    display: grid;
    grid-template-columns: 400px 1fr;
    gap: var(--space-2xl);
  }

  /* LEFT PANEL */
  .image-panel {
    position: sticky;
    top: var(--space-l);
    height: fit-content;
  }

  .upload-section h2,
  .artwork-metadata h3,
  .mode-info h3 {
    font-family: var(--font-heading);
    font-size: var(--text-xl);
    color: var(--color-purple);
    margin-bottom: var(--space-m);
  }

  .upload-area {
    border: 3px dashed var(--color-gray-4);
    border-radius: 12px;
    padding: var(--space-2xl);
    text-align: center;
    cursor: pointer;
    transition: all 0.3s;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: var(--space-m);
    background: var(--color-cream);
  }

  .upload-area:hover,
  .upload-area.dragover {
    border-color: var(--color-orange);
    background: var(--color-white);
  }

  .upload-icon {
    width: 64px;
    height: 64px;
    color: var(--color-gray-5);
  }

  .upload-text {
    font-size: var(--text-lg);
    font-weight: 600;
    color: var(--color-purple);
    margin: 0;
  }

  .upload-hint {
    font-size: var(--text-sm);
    color: var(--color-gray-6);
    margin: 0;
  }

  .image-preview-container {
    position: relative;
    border-radius: 12px;
    overflow: hidden;
    background: var(--color-black);
  }

  .image-preview-container img {
    width: 100%;
    height: auto;
    display: block;
  }

  .remove-image {
    position: absolute;
    top: var(--space-s);
    right: var(--space-s);
    background: var(--color-red);
    color: var(--color-white);
    border: none;
    border-radius: 50%;
    width: 32px;
    height: 32px;
    font-size: 20px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .artwork-metadata {
    margin-top: var(--space-xl);
    padding: var(--space-l);
    background: var(--color-cream);
    border-radius: 8px;
  }

  .form-group {
    margin-bottom: var(--space-m);
  }

  .form-group label {
    display: block;
    font-weight: 600;
    margin-bottom: var(--space-xs);
    color: var(--color-gray-8);
  }

  .form-group input,
  .form-group textarea,
  .form-group .textarea-replacement {
    width: 100%;
    padding: var(--space-s);
    border: 2px solid var(--color-gray-3);
    border-radius: 6px;
    font-family: var(--font-body);
    font-size: var(--text-base);
  }

  .form-group input:focus,
  .form-group textarea:focus,
  .form-group .textarea-replacement:focus {
    outline: none;
    border-color: var(--color-orange);
  }

  /* Contenteditable div acting as textarea */
  .textarea-replacement {
    min-height: 120px;
    max-height: 400px;
    overflow-y: auto;
    white-space: pre-wrap;
    background: var(--color-white);
  }

  .textarea-replacement:empty:before {
    content: attr(data-placeholder);
    color: var(--color-gray-5);
    opacity: 0.7;
  }

  .mode-info {
    margin-top: var(--space-xl);
    padding: var(--space-l);
    background: var(--color-white);
    border: 2px solid var(--color-purple);
    border-radius: 8px;
  }

  .mode-steps {
    margin-top: var(--space-m);
  }

  .mode-steps h4 {
    font-size: var(--text-base);
    margin-bottom: var(--space-s);
  }

  .mode-steps ol {
    margin: 0;
    padding-left: var(--space-l);
    font-size: var(--text-sm);
    line-height: 1.6;
  }

  .mode-steps li {
    margin-bottom: var(--space-xs);
  }

  /* RIGHT PANEL */
  .analysis-panel {
    background: var(--color-white);
    border-radius: 12px;
    padding: var(--space-2xl);
  }

  .form-section {
    margin-bottom: var(--space-3xl);
    padding-bottom: var(--space-2xl);
    border-bottom: 2px solid var(--color-gray-2);
  }

  .form-section:last-of-type {
    border-bottom: none;
  }

  .section-header {
    display: flex;
    align-items: center;
    gap: var(--space-m);
    margin-bottom: var(--space-m);
  }

  .section-number {
    width: 40px;
    height: 40px;
    background: var(--color-orange);
    color: var(--color-white);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 700;
    font-size: var(--text-lg);
  }

  .section-header h2 {
    font-family: var(--font-heading);
    font-size: var(--text-2xl);
    color: var(--color-purple);
    margin: 0;
    flex: 1;
  }

  .section-badge {
    padding: var(--space-xs) var(--space-s);
    background: var(--color-cream);
    color: var(--color-gray-7);
    border-radius: 4px;
    font-size: var(--text-sm);
    font-weight: 600;
  }

  .section-badge.warning {
    background: var(--color-yellow);
    color: var(--color-black);
  }

  .section-description {
    color: var(--color-gray-7);
    margin-bottom: var(--space-l);
  }

  .help-text {
    display: block;
    font-size: var(--text-sm);
    color: var(--color-gray-6);
    font-weight: 400;
    margin-top: var(--space-xs);
  }

  /* ACTION SELECTOR */
  .action-selector {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: var(--space-m);
  }

  .action-option input[type="radio"] {
    display: none;
  }

  .action-card {
    border: 2px solid var(--color-gray-3);
    padding: var(--space-l);
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.2s;
  }

  .action-option input[type="radio"]:checked + .action-card {
    border-color: var(--color-orange);
    background: var(--color-cream);
  }

  .action-card:hover {
    border-color: var(--color-purple);
  }

  .action-card h3 {
    font-family: var(--font-heading);
    font-size: var(--text-lg);
    color: var(--color-purple);
    margin: 0 0 var(--space-xs) 0;
  }

  .action-card .mechanism {
    font-size: var(--text-sm);
    color: var(--color-gray-6);
    font-style: italic;
    margin: 0 0 var(--space-s) 0;
  }

  .action-card p:last-child {
    font-size: var(--text-sm);
    margin: 0;
  }

  /* PRINCIPLES GRID */
  .principles-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: var(--space-m);
  }

  .principle-checkbox {
    display: block;
  }

  .principle-checkbox input[type="checkbox"] {
    display: none;
  }

  .principle-label {
    border: 2px solid var(--color-gray-3);
    padding: var(--space-m);
    border-radius: 6px;
    cursor: pointer;
    transition: all 0.2s;
    display: flex;
    flex-direction: column;
    gap: var(--space-xs);
  }

  .principle-checkbox input[type="checkbox"]:checked + .principle-label {
    border-color: var(--color-orange);
    background: var(--color-cream);
  }

  .principle-label:hover {
    border-color: var(--color-purple);
  }

  .principle-label strong {
    color: var(--color-purple);
    font-size: var(--text-base);
  }

  .tier-badge {
    display: inline-block;
    padding: 2px 8px;
    border-radius: 4px;
    font-size: var(--text-xs);
    font-weight: 600;
  }

  .tier-badge.tier-a {
    background: var(--color-green);
    color: var(--color-white);
  }

  .tier-badge.tier-b {
    background: var(--color-blue);
    color: var(--color-white);
  }

  .tier-badge.tier-c {
    background: var(--color-gray-5);
    color: var(--color-white);
  }

  .principle-subtitle {
    font-size: var(--text-sm);
    color: var(--color-gray-6);
    margin: 0;
  }

  .more-principles {
    margin-top: var(--space-l);
  }

  .more-principles summary {
    cursor: pointer;
    font-weight: 600;
    color: var(--color-purple);
    padding: var(--space-s);
  }

  .more-principles[open] summary {
    margin-bottom: var(--space-m);
  }

  /* ROOTS GRID */
  .evidence-gate {
    padding: var(--space-m);
    border-radius: 8px;
    margin-bottom: var(--space-l);
    border: 2px solid var(--color-yellow);
    background: #fff9e6;
  }

  .evidence-gate.open {
    border-color: var(--color-green);
    background: #e6f9e6;
  }

  .gate-status {
    font-size: var(--text-base);
    margin: 0 0 var(--space-xs) 0;
  }

  .gate-requirement {
    font-size: var(--text-sm);
    color: var(--color-gray-7);
    margin: 0;
  }

  .roots-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: var(--space-m);
  }

  .root-checkbox input[type="checkbox"] {
    display: none;
  }

  .root-label {
    border: 2px solid var(--color-gray-3);
    padding: var(--space-m);
    border-radius: 6px;
    cursor: pointer;
    transition: all 0.2s;
  }

  .root-checkbox input[type="checkbox"]:disabled + .root-label {
    opacity: 0.5;
    cursor: not-allowed;
  }

  .root-checkbox input[type="checkbox"]:checked + .root-label {
    border-color: var(--color-orange);
    background: var(--color-cream);
  }

  .root-label strong {
    color: var(--color-purple);
    font-size: var(--text-base);
    display: block;
    margin-bottom: var(--space-xs);
  }

  .root-subtitle {
    display: block;
    font-size: var(--text-xs);
    color: var(--color-gray-6);
    text-transform: uppercase;
    letter-spacing: 0.05em;
    margin-bottom: var(--space-xs);
  }

  .root-label p {
    font-size: var(--text-sm);
    margin: 0;
    color: var(--color-gray-7);
  }

  /* FRICTION SLIDER */
  .friction-slider {
    padding: var(--space-m) 0;
  }

  .friction-slider input[type="range"] {
    width: 100%;
    margin: var(--space-m) 0;
  }

  .friction-labels {
    display: flex;
    justify-content: space-between;
    font-size: var(--text-sm);
    color: var(--color-gray-6);
  }

  #frictionValue {
    font-weight: 700;
    color: var(--color-orange);
    font-size: var(--text-xl);
  }

  /* VERDICT OPTIONS */
  .verdict-options {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: var(--space-m);
  }

  .verdict-option input[type="radio"] {
    display: none;
  }

  .verdict-card {
    border: 2px solid var(--color-gray-3);
    padding: var(--space-l);
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.2s;
  }

  .verdict-option input[type="radio"]:checked + .verdict-card {
    border-color: var(--color-orange);
    background: var(--color-cream);
  }

  .verdict-card h4 {
    font-family: var(--font-heading);
    font-size: var(--text-lg);
    margin: 0 0 var(--space-s) 0;
  }

  .verdict-card.honest h4 {
    color: var(--color-green);
  }

  .verdict-card.dishonest h4 {
    color: var(--color-red);
  }

  .verdict-card.unclear h4 {
    color: var(--color-gray-6);
  }

  .verdict-card p {
    font-size: var(--text-sm);
    margin: 0;
  }

  /* FORM ACTIONS */
  .form-actions {
    display: flex;
    gap: var(--space-m);
    justify-content: flex-end;
    margin-top: var(--space-2xl);
  }

  .btn-primary,
  .btn-secondary {
    padding: var(--space-m) var(--space-xl);
    border: none;
    border-radius: 6px;
    font-family: var(--font-body);
    font-size: var(--text-base);
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s;
  }

  .btn-primary {
    background: var(--color-orange);
    color: var(--color-white);
  }

  .btn-primary:hover {
    background: var(--color-purple);
  }

  .btn-secondary {
    background: var(--color-white);
    color: var(--color-purple);
    border: 2px solid var(--color-purple);
  }

  .btn-secondary:hover {
    background: var(--color-purple);
    color: var(--color-white);
  }

  /* RESULTS PANEL */
  .results-panel {
    background: var(--color-white);
  }

  .results-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: var(--space-xl);
    padding-bottom: var(--space-l);
    border-bottom: 2px solid var(--color-gray-2);
  }

  .results-header h2 {
    font-family: var(--font-heading);
    font-size: var(--text-3xl);
    color: var(--color-purple);
    margin: 0;
  }

  .results-content {
    line-height: 1.7;
  }

  .report h1 {
    font-family: var(--font-display);
    font-size: var(--text-4xl);
    color: var(--color-orange);
    margin-bottom: var(--space-l);
  }

  .report-meta {
    background: var(--color-cream);
    padding: var(--space-m);
    border-radius: 6px;
    margin-bottom: var(--space-2xl);
  }

  .report-section {
    margin-bottom: var(--space-2xl);
  }

  .report-section h2 {
    font-family: var(--font-heading);
    font-size: var(--text-2xl);
    color: var(--color-purple);
    margin-bottom: var(--space-m);
  }

  .report-section h3 {
    font-family: var(--font-heading);
    font-size: var(--text-lg);
    color: var(--color-gray-8);
    margin: var(--space-l) 0 var(--space-s) 0;
  }

  .report-section pre {
    background: var(--color-cream);
    padding: var(--space-m);
    border-radius: 6px;
    white-space: pre-wrap;
    font-family: var(--font-body);
    font-size: var(--text-base);
  }

  .action-result,
  .verdict-result {
    font-size: var(--text-xl);
    font-weight: 700;
    padding: var(--space-m);
    border-radius: 6px;
    display: inline-block;
  }

  .action-result {
    background: var(--color-cream);
    color: var(--color-purple);
  }

  .verdict-result.honest {
    background: var(--color-green);
    color: var(--color-white);
  }

  .verdict-result.dishonest {
    background: var(--color-red);
    color: var(--color-white);
  }

  .verdict-result.unclear {
    background: var(--color-gray-4);
    color: var(--color-gray-8);
  }

  .report-footer {
    margin-top: var(--space-2xl);
    padding-top: var(--space-l);
    border-top: 2px solid var(--color-gray-2);
    font-style: italic;
    color: var(--color-gray-6);
  }

  .results-actions {
    display: flex;
    gap: var(--space-m);
    margin-top: var(--space-2xl);
  }

  @media (max-width: 1200px) {
    .analyze-container {
      grid-template-columns: 1fr;
    }

    .image-panel {
      position: static;
    }

    .action-selector,
    .principles-grid,
    .roots-grid,
    .verdict-options {
      grid-template-columns: 1fr;
    }
  }
</style>
