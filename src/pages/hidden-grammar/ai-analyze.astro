---
import BaseLayout from '../../layouts/BaseLayout.astro';
import HiddenGrammarNav from '../../components/HiddenGrammarNav.astro';

  const modes = await import('../../data/hg-modes.json');
  const lenses = await import('../../data/hg-lenses.json');
---

<BaseLayout
  title="AI Art Analysis - Hidden Grammar"
>
  <div class="hg-layout">
    <HiddenGrammarNav />
    <div class="hg-content">
      <div class="page-container">
        <div class="content-wrapper">
      <header class="page-header">
        <h1>Hidden Grammar AI Analysis</h1>
        <p class="subtitle">Upload artwork and receive instant AI-powered analysis using the Hidden Grammar framework</p>
      </header>

      <main class="analysis-container">
        <!-- Analysis Form -->
        <div id="analysisForm" class="analysis-form">

          <!-- Section 0: Image Upload & Metadata -->
          <section class="form-section">
            <div class="section-header">
              <span class="section-number">1</span>
              <h2>Upload Artwork</h2>
            </div>

            <!-- Image Upload -->
            <div class="upload-container">
              <div id="uploadArea" class="upload-area">
                <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                  <polyline points="17 8 12 3 7 8"></polyline>
                  <line x1="12" y1="3" x2="12" y2="15"></line>
                </svg>
                <p><strong>Click to upload</strong> or drag & drop</p>
                <p class="upload-hint">JPG, PNG, WebP (large images auto-optimized)</p>
                <input type="file" id="imageInput" accept="image/*" hidden>
              </div>

              <div id="imagePreviewContainer" class="image-preview-container" style="display: none;">
                <img id="imagePreview" alt="Uploaded artwork">
                <button type="button" id="removeImage" class="btn-remove">Remove Image</button>
              </div>
            </div>

            <!-- Basic Metadata (Optional) -->
            <div class="metadata-grid">
              <div class="form-group">
                <label for="artworkTitle">Artwork Title <span class="optional">(optional)</span></label>
                <input type="text" id="artworkTitle" placeholder="e.g., Starry Night">
              </div>

              <div class="form-group">
                <label for="artistName">Artist <span class="optional">(optional)</span></label>
                <input type="text" id="artistName" placeholder="e.g., Vincent van Gogh">
              </div>

              <div class="form-group">
                <label for="yearCreated">Year <span class="optional">(optional)</span></label>
                <input type="text" id="yearCreated" placeholder="e.g., 1889">
              </div>

              <div class="form-group">
                <label for="medium">Medium <span class="optional">(optional)</span></label>
                <input type="text" id="medium" placeholder="e.g., Oil on canvas">
              </div>

              <div class="form-group">
                <label for="dimensions">Dimensions <span class="optional">(optional, in inches)</span></label>
                <input type="text" id="dimensions" placeholder="e.g., 24 x 36 or 18 x 24 x 2">
              </div>

              <div class="form-group full-width">
                <label for="artistStatement">Artist Statement <span class="optional">(optional)</span></label>
                <textarea id="artistStatement" rows="4" placeholder="Paste the artist statement here..."></textarea>
              </div>

              <div class="form-group full-width">
                <label for="contextNote">Exhibition Context/Lens <span class="optional">(optional)</span></label>
                <textarea id="contextNote" rows="3" placeholder="e.g., Theme of the exhibit, specific curator notes, or situational context..."></textarea>
              </div>
            </div>
          </section>

          <!-- Section 2: Analysis Configuration -->
          <section class="form-section">
            <div class="section-header">
              <span class="section-number">2</span>
              <h2>Configure Analysis</h2>
            </div>

            <!-- Custom Prompt Input -->
            <div class="custom-prompt-section">
              <div class="subsection-header">
                <h3>Custom Analysis Prompt</h3>
                <p class="subsection-description">Write your own analysis instructions or questions for the AI</p>
              </div>
              
              <div class="form-group">
                <label for="customPrompt">
                  Custom Prompt <span class="optional">(optional - leave blank to use a pre-formatted mode below)</span>
                </label>
                <textarea 
                  id="customPrompt" 
                  rows="6"
                  placeholder="Example: Focus on the color palette and how it creates mood. Explain the composition choices and their effect on the viewer's attention. Compare this work to Impressionist techniques..."
                ></textarea>
                <p class="field-hint">
                  When you provide a custom prompt, the AI will use your instructions instead of the pre-formatted modes below.
                  The Hidden Grammar framework data (11 Roots, 54 Principles) will still be available to the AI.
                </p>
              </div>
            </div>

            <!-- Advanced Lenses (Optional) -->
            <div class="lenses-section">
              <div class="subsection-header">
                <h3>Advanced Focus Lenses</h3>
                <p class="subsection-description">Apply a specific philosophical or critical filter to your analysis</p>
              </div>

              <div class="form-group">
                <label for="lensSelector">Select a Lens <span class="optional">(optional)</span></label>
                <select id="lensSelector" class="lens-select">
                  <option value="">None (Standard Analysis)</option>
                  {lenses.categories.map(category => (
                    <optgroup label={category.name}>
                      {lenses.lenses
                        .filter(lens => lens.category === category.id)
                        .map(lens => (
                          <option value={lens.id} data-prompt={lens.prompt}>{lens.name}</option>
                        ))
                      }
                    </optgroup>
                  ))}
                </select>
                <p class="field-hint" id="lensDescription">
                  Select a lens to see its description here.
                </p>
              </div>
            </div>

            <!-- Pre-formatted Analysis Modes -->
            <div class="preformatted-modes-section">
              <div class="subsection-header">
                <h3>Pre-formatted Analysis Modes</h3>
                <p class="subsection-description">Or choose a structured analysis template</p>
              </div>

              <div class="mode-selector">
                {modes.modes.map((mode) => (
                  <label class="mode-card">
                    <input type="radio" name="analysisMode" value={mode.id}>
                    <div class="mode-content">
                      <h3>{mode.name}</h3>
                      <p class="mode-phase">{mode.phase}</p>
                      <p class="mode-description">{mode.description}</p>
                    </div>
                  </label>
                ))}
              </div>
            </div>
          </section>

          <!-- Action Buttons -->
          <div class="form-actions">
            <button type="button" class="btn-primary" id="analyzeBtn" disabled>
              <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="m8 3 4 8 5-5 5 15H2L8 3z"></path>
              </svg>
              Analyze with AI
            </button>
          </div>
        </div>

        <!-- Loading State -->
        <div id="loadingState" class="loading-state" style="display: none;">
          <div class="loading-spinner"></div>
          <h2>Analyzing artwork...</h2>
          <p>AI is examining the visual grammar and generating your analysis report</p>
        </div>

        <!-- Results Panel -->
        <div id="resultsPanel" class="results-panel" style="display: none;">
          <div class="results-header">
            <h2>Analysis Results</h2>
            <div class="results-actions">
              <button class="btn-secondary" id="backToForm">‚Üê New Analysis</button>
              <button class="btn-secondary" id="exportMarkdown">Export Markdown</button>
              <button class="btn-secondary" id="exportJSON">Export JSON</button>
              <button class="btn-secondary" id="exportPDF">Export PDF</button>
              <button class="btn-secondary" id="copyToClipboard">Copy to Clipboard</button>
            </div>
          </div>
          <div id="resultsContent" class="results-content"></div>
        </div>
      </main>
        </div>
      </div>
    </div>
  </div>
</BaseLayout>

<script>
  import '../../scripts/ai-analyze/index';
</script>

<style>
  /* Box-sizing for all Hidden Grammar elements */
  .hg-layout *,
  .hg-layout *::before,
  .hg-layout *::after {
    box-sizing: border-box;
  }

  .hg-layout {
    display: flex;
    min-height: calc(100vh - 200px);
  }

  .hg-content {
    flex: 1;
    overflow-y: auto;
  }

  @media (max-width: 1023px) {
    .hg-layout {
      flex-direction: column;
    }
  }

  .page-container {
    min-height: 100vh;
    background: var(--color-gray-1);
    padding: clamp(1rem, 5vw, 3rem) clamp(1rem, 4vw, 2rem);
  }

  .content-wrapper {
    max-width: 1200px;
    margin: 0 auto;
  }

  .page-header {
    text-align: center;
    margin-bottom: clamp(2rem, 5vw, 3rem);
  }

  .page-header h1 {
    font-family: var(--font-display);
    font-size: clamp(2rem, 5vw, 2.5rem);
    color: var(--color-purple);
    margin-bottom: clamp(0.5rem, 1.5vw, 0.75rem);
  }

  .subtitle {
    font-size: clamp(1rem, 2vw, 1.125rem);
    color: var(--color-gray-7);
    max-width: 600px;
    margin: 0 auto;
    line-height: 1.6;
    padding: 0 clamp(1rem, 3vw, 2rem);
  }

  .analysis-container {
    background: var(--color-white);
    border-radius: 12px;
    padding: clamp(1.5rem, 4vw, 3rem);
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
  }

  .form-section {
    margin-bottom: clamp(2rem, 5vw, 3rem);
    padding-bottom: clamp(1.5rem, 4vw, 3rem);
    border-bottom: 2px solid var(--color-gray-2);
  }

  .form-section:last-of-type {
    border-bottom: none;
  }

  .section-header {
    display: flex;
    align-items: center;
    gap: clamp(0.75rem, 2vw, 1rem);
    margin-bottom: clamp(1rem, 3vw, 1.5rem);
  }

  .section-number {
    display: flex;
    align-items: center;
    justify-content: center;
    width: clamp(36px, 8vw, 40px);
    height: clamp(36px, 8vw, 40px);
    flex-shrink: 0;
    background: var(--color-purple);
    color: var(--color-white);
    border-radius: 50%;
    font-weight: 700;
    font-size: clamp(1rem, 2.5vw, 1.125rem);
  }

  .section-header h2 {
    font-family: var(--font-heading);
    font-size: clamp(1.5rem, 3.5vw, 1.75rem);
    color: var(--color-gray-9);
    margin: 0;
  }

  .section-description {
    color: var(--color-gray-6);
    font-size: clamp(0.875rem, 2vw, 1rem);
    line-height: 1.6;
    margin-bottom: clamp(1rem, 3vw, 1.5rem);
  }

  /* Subsections */
  .custom-prompt-section,
  .preformatted-modes-section {
    margin-bottom: clamp(2rem, 5vw, 3rem);
    transition: opacity 0.2s ease;
  }

  .custom-prompt-section.inactive,
  .preformatted-modes-section.inactive {
    opacity: 0.4;
    pointer-events: none;
  }

  .subsection-header {
    margin-bottom: clamp(1rem, 3vw, 1.5rem);
  }

  .subsection-header h3 {
    font-family: var(--font-heading);
    font-size: clamp(1.25rem, 3vw, 1.5rem);
    color: var(--color-purple);
    margin: 0 0 clamp(0.375rem, 1vw, 0.5rem) 0;
  }

  .subsection-description {
    color: var(--color-gray-6);
    font-size: clamp(0.875rem, 2vw, 1rem);
    line-height: 1.6;
    margin: 0;
  }

  .field-hint {
    font-size: clamp(0.8125rem, 1.8vw, 0.875rem);
    color: var(--color-gray-5);
    line-height: 1.5;
    margin-top: clamp(0.375rem, 1vw, 0.5rem);
    font-style: italic;
  }

  /* Upload Area */
  .upload-area {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: clamp(2rem, 5vw, 3rem);
    border: 3px dashed var(--color-gray-4);
    border-radius: 12px;
    background: var(--color-gray-1);
    cursor: pointer;
    transition: all 0.2s ease;
    margin-bottom: clamp(1rem, 3vw, 1.5rem);
    min-height: clamp(180px, 25vw, 200px);
  }

  .upload-area:hover,
  .upload-area.dragover {
    border-color: var(--color-purple);
    background: var(--color-purple-light);
  }

  .upload-area svg {
    color: var(--color-purple);
    margin-bottom: var(--space-m);
  }

  .upload-area p {
    margin: var(--space-xs) 0;
    color: var(--color-gray-7);
  }

  .upload-hint {
    font-size: var(--text-sm);
    color: var(--color-gray-5);
  }

  .image-preview-container {
    position: relative;
    border-radius: 8px;
    overflow: hidden;
    margin-bottom: var(--space-l);
  }

  .image-preview-container img {
    width: 100%;
    max-height: 600px;
    object-fit: contain;
    background: var(--color-gray-1);
  }

  .btn-remove {
    position: absolute;
    top: var(--space-m);
    right: var(--space-m);
    background: rgba(0, 0, 0, 0.7);
    color: var(--color-white);
    border: none;
    padding: var(--space-s) var(--space-m);
    border-radius: 6px;
    cursor: pointer;
    font-weight: 600;
  }

  .btn-remove:hover {
    background: rgba(0, 0, 0, 0.9);
  }

  /* Metadata Grid */
  .metadata-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(min(100%, 250px), 1fr));
    gap: clamp(0.75rem, 2vw, 1rem);
  }

  .form-group.full-width {
    grid-column: 1 / -1;
  }

  .form-group label {
    display: block;
    font-weight: 600;
    margin-bottom: clamp(0.375rem, 1vw, 0.5rem);
    color: var(--color-gray-8);
    font-size: clamp(0.875rem, 2vw, 1rem);
  }

  .optional {
    font-weight: 400;
    color: var(--color-gray-5);
    font-size: clamp(0.75rem, 1.5vw, 0.875rem);
  }

  .form-group input,
  .form-group textarea {
    width: 100%;
    padding: clamp(0.5rem, 2vw, 0.75rem);
    border: 2px solid var(--color-gray-3);
    border-radius: 6px;
    font-family: var(--font-body);
    font-size: clamp(0.875rem, 2vw, 1rem);
  }

  .form-group textarea {
    resize: vertical;
    min-height: 120px;
    line-height: 1.6;
  }

  .form-group input:focus,
  .form-group textarea:focus {
    outline: none;
    border-color: var(--color-purple);
  }

  /* Mode Selector */
  .mode-selector {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(min(100%, 280px), 1fr));
    gap: clamp(0.75rem, 2vw, 1rem);
  }

  .mode-card {
    position: relative;
    display: block;
    cursor: pointer;
  }

  .mode-card input[type="radio"] {
    position: absolute;
    opacity: 0;
  }

  .mode-content {
    padding: clamp(1rem, 3vw, 1.5rem);
    border: 0.5px solid var(--color-purple);
    border-radius: 8px;
    transition: all 0.2s ease;
    background: var(--color-white);
    height: 100%;
    min-height: 120px;
  }

  .mode-card input:checked + .mode-content {
    border-width: 2px;
    border-color: var(--color-purple);
    background: var(--color-purple-light);
  }

  .mode-card:hover .mode-content {
    border-color: var(--color-purple);
  }

  .mode-content h3 {
    font-family: var(--font-heading);
    font-size: var(--text-lg);
    color: var(--color-purple);
    margin: 0 0 var(--space-xs);
  }

  .mode-phase {
    font-size: var(--text-sm);
    color: var(--color-gray-6);
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    margin: 0 0 var(--space-s);
  }

  .mode-description {
    font-size: var(--text-sm);
    color: var(--color-gray-7);
    margin: 0;
    line-height: 1.5;
  }

  /* Action Buttons */
  .form-actions {
    display: flex;
    justify-content: center;
    flex-wrap: wrap;
    gap: clamp(0.75rem, 2vw, 1rem);
    margin-top: clamp(2rem, 5vw, 3rem);
  }

  .btn-primary,
  .btn-secondary {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: clamp(0.5rem, 1.5vw, 0.75rem);
    padding: clamp(0.75rem, 2.5vw, 1rem) clamp(1.5rem, 4vw, 3rem);
    border: none;
    border-radius: 8px;
    font-family: var(--font-heading);
    font-size: clamp(0.875rem, 2vw, 1rem);
    font-weight: 700;
    cursor: pointer;
    transition: all 0.2s ease;
    min-height: 44px;
  }

  .btn-primary {
    background: var(--color-purple);
    color: var(--color-white);
  }

  .btn-primary:hover:not(:disabled) {
    background: var(--color-purple-dark);
    box-shadow: 0 4px 12px rgba(124, 58, 237, 0.3);
  }

  .btn-primary:disabled {
    background: var(--color-gray-4);
    cursor: not-allowed;
  }

  .btn-secondary {
    background: var(--color-white);
    color: var(--color-purple);
    border: 2px solid var(--color-purple);
  }

  .btn-secondary:hover {
    background: var(--color-purple-light);
  }

  /* Loading State */
  .loading-state {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: var(--space-3xl);
    text-align: center;
  }

  .loading-spinner {
    width: 60px;
    height: 60px;
    border: 4px solid var(--color-gray-3);
    border-top-color: var(--color-purple);
    border-radius: 50%;
    animation: spin 1s linear infinite;
    margin-bottom: var(--space-xl);
  }

  @keyframes spin {
    to { transform: rotate(360deg); }
  }

  .loading-state h2 {
    font-family: var(--font-heading);
    color: var(--color-purple);
    margin-bottom: var(--space-m);
  }

  .loading-state p {
    color: var(--color-gray-6);
  }

  /* Results Panel */
  .results-panel {
    padding: var(--space-xl);
  }

  .results-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: var(--space-xl);
    padding-bottom: var(--space-l);
    border-bottom: 2px solid var(--color-gray-2);
  }

  .results-header h2 {
    font-family: var(--font-display);
    font-size: var(--text-3xl);
    color: var(--color-purple);
    margin: 0;
  }

  .results-actions {
    display: flex;
    gap: var(--space-m);
    flex-wrap: wrap;
  }

  .results-content {
    font-family: var(--font-body);
    line-height: 1.8;
    color: var(--color-gray-8);
  }

  @media (max-width: 768px) {
    .page-header h1 {
      font-size: var(--text-3xl);
    }

    .mode-selector {
      grid-template-columns: 1fr;
    }

    .metadata-grid {
      grid-template-columns: 1fr;
    }

    .results-header {
      flex-direction: column;
      align-items: flex-start;
      gap: var(--space-m);
    }

    .results-actions {
      flex-direction: column;
      width: 100%;
    }

    .btn-secondary {
      width: 100%;
      justify-content: center;
    }
  }
</style>
