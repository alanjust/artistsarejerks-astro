---
import BaseLayout from '../../layouts/BaseLayout.astro';
import HiddenGrammarNav from '../../components/HiddenGrammarNav.astro';

const principles = await import('../../data/hg-principles.json');
const roots = await import('../../data/hg-roots.json');
const modes = await import('../../data/hg-modes.json');
---

<BaseLayout
  title="AI Art Analysis - Hidden Grammar"
>
  <div class="hg-layout">
    <HiddenGrammarNav />
    <div class="hg-content">
      <div class="page-container">
        <div class="content-wrapper">
      <header class="page-header">
        <h1>Hidden Grammar AI Analysis</h1>
        <p class="subtitle">Upload artwork and receive instant AI-powered analysis using the Hidden Grammar framework</p>
      </header>

      <main class="analysis-container">
        <!-- Analysis Form -->
        <div id="analysisForm" class="analysis-form">

          <!-- Section 0: Image Upload & Metadata -->
          <section class="form-section">
            <div class="section-header">
              <span class="section-number">1</span>
              <h2>Upload Artwork</h2>
            </div>

            <!-- Image Upload -->
            <div class="upload-container">
              <div id="uploadArea" class="upload-area">
                <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                  <polyline points="17 8 12 3 7 8"></polyline>
                  <line x1="12" y1="3" x2="12" y2="15"></line>
                </svg>
                <p><strong>Click to upload</strong> or drag & drop</p>
                <p class="upload-hint">JPG, PNG, WebP up to 10MB</p>
                <input type="file" id="imageInput" accept="image/*" hidden>
              </div>

              <div id="imagePreviewContainer" class="image-preview-container" style="display: none;">
                <img id="imagePreview" alt="Uploaded artwork">
                <button type="button" id="removeImage" class="btn-remove">Remove Image</button>
              </div>
            </div>

            <!-- Basic Metadata (Optional) -->
            <div class="metadata-grid">
              <div class="form-group">
                <label for="artworkTitle">Artwork Title <span class="optional">(optional)</span></label>
                <input type="text" id="artworkTitle" placeholder="e.g., Starry Night">
              </div>

              <div class="form-group">
                <label for="artistName">Artist <span class="optional">(optional)</span></label>
                <input type="text" id="artistName" placeholder="e.g., Vincent van Gogh">
              </div>

              <div class="form-group">
                <label for="yearCreated">Year <span class="optional">(optional)</span></label>
                <input type="text" id="yearCreated" placeholder="e.g., 1889">
              </div>

              <div class="form-group">
                <label for="medium">Medium <span class="optional">(optional)</span></label>
                <input type="text" id="medium" placeholder="e.g., Oil on canvas">
              </div>

              <div class="form-group">
                <label for="dimensions">Dimensions <span class="optional">(optional, in inches)</span></label>
                <input type="text" id="dimensions" placeholder="e.g., 24 x 36 or 18 x 24 x 2">
              </div>
            </div>
          </section>

          <!-- Section 1: Analysis Mode Selection -->
          <section class="form-section">
            <div class="section-header">
              <span class="section-number">2</span>
              <h2>Select Analysis Mode</h2>
            </div>
            <p class="section-description">Choose the type of analysis you want</p>

            <div class="mode-selector">
              {modes.modes.map((mode) => (
                <label class="mode-card">
                  <input type="radio" name="analysisMode" value={mode.id} checked={mode.id === 'strategic'}>
                  <div class="mode-content">
                    <h3>{mode.name}</h3>
                    <p class="mode-phase">{mode.phase}</p>
                    <p class="mode-description">{mode.description}</p>
                  </div>
                </label>
              ))}
            </div>
          </section>

          <!-- Action Buttons -->
          <div class="form-actions">
            <button type="button" class="btn-primary" id="analyzeBtn" disabled>
              <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="m8 3 4 8 5-5 5 15H2L8 3z"></path>
              </svg>
              Analyze with AI
            </button>
          </div>
        </div>

        <!-- Loading State -->
        <div id="loadingState" class="loading-state" style="display: none;">
          <div class="loading-spinner"></div>
          <h2>Analyzing artwork...</h2>
          <p>AI is examining the visual grammar and generating your analysis report</p>
        </div>

        <!-- Results Panel -->
        <div id="resultsPanel" class="results-panel" style="display: none;">
          <div class="results-header">
            <h2>Analysis Results</h2>
            <div class="results-actions">
              <button class="btn-secondary" id="backToForm">‚Üê New Analysis</button>
              <button class="btn-secondary" id="exportMarkdown">Export Markdown</button>
              <button class="btn-secondary" id="copyToClipboard">Copy to Clipboard</button>
            </div>
          </div>
          <div id="resultsContent" class="results-content"></div>
        </div>
      </main>
        </div>
      </div>
    </div>
  </div>
</BaseLayout>

<script>
  // Image Upload Handling
  const uploadArea = document.getElementById('uploadArea');
  const imageInput = document.getElementById('imageInput');
  const imagePreviewContainer = document.getElementById('imagePreviewContainer');
  const imagePreview = document.getElementById('imagePreview');
  const removeImage = document.getElementById('removeImage');
  const analyzeBtn = document.getElementById('analyzeBtn');

  let uploadedImageData: string | null = null;

  uploadArea?.addEventListener('click', () => imageInput?.click());

  uploadArea?.addEventListener('dragover', (e) => {
    e.preventDefault();
    uploadArea.classList.add('dragover');
  });

  uploadArea?.addEventListener('dragleave', () => {
    uploadArea.classList.remove('dragover');
  });

  uploadArea?.addEventListener('drop', (e) => {
    e.preventDefault();
    uploadArea.classList.remove('dragover');
    const file = e.dataTransfer?.files[0];
    if (file && file.type.startsWith('image/')) {
      handleImageUpload(file);
    }
  });

  imageInput?.addEventListener('change', (e) => {
    const file = (e.target as HTMLInputElement).files?.[0];
    if (file) {
      handleImageUpload(file);
    }
  });

  removeImage?.addEventListener('click', () => {
    if (imageInput) (imageInput as HTMLInputElement).value = '';
    if (imagePreview) (imagePreview as HTMLImageElement).src = '';
    if (uploadArea) uploadArea.style.display = 'flex';
    if (imagePreviewContainer) imagePreviewContainer.style.display = 'none';
    uploadedImageData = null;
    if (analyzeBtn) (analyzeBtn as HTMLButtonElement).disabled = true;
  });

  function handleImageUpload(file: File) {
    const reader = new FileReader();
    reader.onload = (e) => {
      if (imagePreview && e.target?.result) {
        (imagePreview as HTMLImageElement).src = e.target.result as string;
        uploadedImageData = e.target.result as string;
        if (uploadArea) uploadArea.style.display = 'none';
        if (imagePreviewContainer) imagePreviewContainer.style.display = 'block';
        if (analyzeBtn) (analyzeBtn as HTMLButtonElement).disabled = false;
      }
    };
    reader.readAsDataURL(file);
  }

  // Analyze Button Handler
  const loadingState = document.getElementById('loadingState');
  const resultsPanel = document.getElementById('resultsPanel');
  const analysisForm = document.getElementById('analysisForm');
  const resultsContent = document.getElementById('resultsContent');
  const backToForm = document.getElementById('backToForm');

  analyzeBtn?.addEventListener('click', async () => {
    if (!uploadedImageData) {
      alert('Please upload an image first');
      return;
    }

    // Get form data
    const title = (document.getElementById('artworkTitle') as HTMLInputElement)?.value || 'Untitled';
    const artist = (document.getElementById('artistName') as HTMLInputElement)?.value || 'Unknown Artist';
    const year = (document.getElementById('yearCreated') as HTMLInputElement)?.value;
    const medium = (document.getElementById('medium') as HTMLInputElement)?.value;
    const dimensions = (document.getElementById('dimensions') as HTMLInputElement)?.value;
    const mode = (document.querySelector('input[name="analysisMode"]:checked') as HTMLInputElement)?.value || 'strategic';

    // Show loading state
    if (analysisForm) analysisForm.style.display = 'none';
    if (loadingState) loadingState.style.display = 'flex';

    try {
      // Call API endpoint to analyze image
      const response = await fetch('/api/analyze-artwork', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          image: uploadedImageData,
          title,
          artist,
          year,
          medium,
          dimensions,
          mode,
        }),
      });

      const result = await response.json();

      if (!response.ok) {
        console.error('API Error:', result);
        alert(`Analysis failed: ${result.details || result.error}\n\nAPI Key Present: ${result.apiKeyPresent}\n\nCheck console for more details.`);
        if (loadingState) loadingState.style.display = 'none';
        if (analysisForm) analysisForm.style.display = 'block';
        return;
      }

      // Display results
      if (resultsContent) {
        resultsContent.innerHTML = result.analysis;
      }
      if (loadingState) loadingState.style.display = 'none';
      if (resultsPanel) resultsPanel.style.display = 'block';
      window.scrollTo(0, 0);

    } catch (error) {
      console.error('Analysis error:', error);
      alert('Failed to analyze artwork. Please try again.\n\nCheck console for more details.');
      if (loadingState) loadingState.style.display = 'none';
      if (analysisForm) analysisForm.style.display = 'block';
    }
  });

  backToForm?.addEventListener('click', () => {
    if (analysisForm) analysisForm.style.display = 'block';
    if (resultsPanel) resultsPanel.style.display = 'none';
    window.scrollTo(0, 0);
  });

  // Export functionality (placeholder - will implement after API is working)
  const exportBtn = document.getElementById('exportMarkdown');
  const copyBtn = document.getElementById('copyToClipboard');

  exportBtn?.addEventListener('click', () => {
    const content = resultsContent?.textContent || '';
    const blob = new Blob([content], { type: 'text/markdown' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'hidden-grammar-analysis.md';
    a.click();
    URL.revokeObjectURL(url);
  });

  copyBtn?.addEventListener('click', () => {
    const content = resultsContent?.textContent || '';
    navigator.clipboard.writeText(content).then(() => {
      alert('Analysis copied to clipboard!');
    });
  });
</script>

<style>
  /* Box-sizing for all Hidden Grammar elements */
  .hg-layout *,
  .hg-layout *::before,
  .hg-layout *::after {
    box-sizing: border-box;
  }

  .hg-layout {
    display: flex;
    min-height: calc(100vh - 200px);
  }

  .hg-content {
    flex: 1;
    overflow-y: auto;
  }

  @media (max-width: 1023px) {
    .hg-layout {
      flex-direction: column;
    }
  }

  .page-container {
    min-height: 100vh;
    background: var(--color-gray-1);
    padding: clamp(1rem, 5vw, 3rem) clamp(1rem, 4vw, 2rem);
  }

  .content-wrapper {
    max-width: 1200px;
    margin: 0 auto;
  }

  .page-header {
    text-align: center;
    margin-bottom: clamp(2rem, 5vw, 3rem);
  }

  .page-header h1 {
    font-family: var(--font-display);
    font-size: clamp(2rem, 5vw, 2.5rem);
    color: var(--color-purple);
    margin-bottom: clamp(0.5rem, 1.5vw, 0.75rem);
  }

  .subtitle {
    font-size: clamp(1rem, 2vw, 1.125rem);
    color: var(--color-gray-7);
    max-width: 600px;
    margin: 0 auto;
    line-height: 1.6;
    padding: 0 clamp(1rem, 3vw, 2rem);
  }

  .analysis-container {
    background: var(--color-white);
    border-radius: 12px;
    padding: clamp(1.5rem, 4vw, 3rem);
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
  }

  .form-section {
    margin-bottom: clamp(2rem, 5vw, 3rem);
    padding-bottom: clamp(1.5rem, 4vw, 3rem);
    border-bottom: 2px solid var(--color-gray-2);
  }

  .form-section:last-of-type {
    border-bottom: none;
  }

  .section-header {
    display: flex;
    align-items: center;
    gap: clamp(0.75rem, 2vw, 1rem);
    margin-bottom: clamp(1rem, 3vw, 1.5rem);
  }

  .section-number {
    display: flex;
    align-items: center;
    justify-content: center;
    width: clamp(36px, 8vw, 40px);
    height: clamp(36px, 8vw, 40px);
    flex-shrink: 0;
    background: var(--color-purple);
    color: var(--color-white);
    border-radius: 50%;
    font-weight: 700;
    font-size: clamp(1rem, 2.5vw, 1.125rem);
  }

  .section-header h2 {
    font-family: var(--font-heading);
    font-size: clamp(1.5rem, 3.5vw, 1.75rem);
    color: var(--color-gray-9);
    margin: 0;
  }

  .section-description {
    color: var(--color-gray-6);
    font-size: clamp(0.875rem, 2vw, 1rem);
    line-height: 1.6;
    margin-bottom: clamp(1rem, 3vw, 1.5rem);
  }

  /* Upload Area */
  .upload-area {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: clamp(2rem, 5vw, 3rem);
    border: 3px dashed var(--color-gray-4);
    border-radius: 12px;
    background: var(--color-gray-1);
    cursor: pointer;
    transition: all 0.2s ease;
    margin-bottom: clamp(1rem, 3vw, 1.5rem);
    min-height: clamp(180px, 25vw, 200px);
  }

  .upload-area:hover,
  .upload-area.dragover {
    border-color: var(--color-purple);
    background: var(--color-purple-light);
  }

  .upload-area svg {
    color: var(--color-purple);
    margin-bottom: var(--space-m);
  }

  .upload-area p {
    margin: var(--space-xs) 0;
    color: var(--color-gray-7);
  }

  .upload-hint {
    font-size: var(--text-sm);
    color: var(--color-gray-5);
  }

  .image-preview-container {
    position: relative;
    border-radius: 8px;
    overflow: hidden;
    margin-bottom: var(--space-l);
  }

  .image-preview-container img {
    width: 100%;
    max-height: 600px;
    object-fit: contain;
    background: var(--color-gray-1);
  }

  .btn-remove {
    position: absolute;
    top: var(--space-m);
    right: var(--space-m);
    background: rgba(0, 0, 0, 0.7);
    color: var(--color-white);
    border: none;
    padding: var(--space-s) var(--space-m);
    border-radius: 6px;
    cursor: pointer;
    font-weight: 600;
  }

  .btn-remove:hover {
    background: rgba(0, 0, 0, 0.9);
  }

  /* Metadata Grid */
  .metadata-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(min(100%, 250px), 1fr));
    gap: clamp(0.75rem, 2vw, 1rem);
  }

  .form-group label {
    display: block;
    font-weight: 600;
    margin-bottom: clamp(0.375rem, 1vw, 0.5rem);
    color: var(--color-gray-8);
    font-size: clamp(0.875rem, 2vw, 1rem);
  }

  .optional {
    font-weight: 400;
    color: var(--color-gray-5);
    font-size: clamp(0.75rem, 1.5vw, 0.875rem);
  }

  .form-group input {
    width: 100%;
    padding: clamp(0.5rem, 2vw, 0.75rem);
    border: 2px solid var(--color-gray-3);
    border-radius: 6px;
    font-family: var(--font-body);
    font-size: clamp(0.875rem, 2vw, 1rem);
  }

  .form-group input:focus {
    outline: none;
    border-color: var(--color-purple);
  }

  /* Mode Selector */
  .mode-selector {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(min(100%, 280px), 1fr));
    gap: clamp(0.75rem, 2vw, 1rem);
  }

  .mode-card {
    position: relative;
    display: block;
    cursor: pointer;
  }

  .mode-card input[type="radio"] {
    position: absolute;
    opacity: 0;
  }

  .mode-content {
    padding: clamp(1rem, 3vw, 1.5rem);
    border: 2px solid var(--color-gray-3);
    border-radius: 8px;
    transition: all 0.2s ease;
    background: var(--color-white);
    height: 100%;
    min-height: 120px;
  }

  .mode-card input:checked + .mode-content {
    border-color: var(--color-purple);
    background: var(--color-purple-light);
  }

  .mode-card:hover .mode-content {
    border-color: var(--color-purple);
  }

  .mode-content h3 {
    font-family: var(--font-heading);
    font-size: var(--text-lg);
    color: var(--color-purple);
    margin: 0 0 var(--space-xs);
  }

  .mode-phase {
    font-size: var(--text-sm);
    color: var(--color-gray-6);
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    margin: 0 0 var(--space-s);
  }

  .mode-description {
    font-size: var(--text-sm);
    color: var(--color-gray-7);
    margin: 0;
    line-height: 1.5;
  }

  /* Action Buttons */
  .form-actions {
    display: flex;
    justify-content: center;
    flex-wrap: wrap;
    gap: clamp(0.75rem, 2vw, 1rem);
    margin-top: clamp(2rem, 5vw, 3rem);
  }

  .btn-primary,
  .btn-secondary {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: clamp(0.5rem, 1.5vw, 0.75rem);
    padding: clamp(0.75rem, 2.5vw, 1rem) clamp(1.5rem, 4vw, 3rem);
    border: none;
    border-radius: 8px;
    font-family: var(--font-heading);
    font-size: clamp(0.875rem, 2vw, 1rem);
    font-weight: 700;
    cursor: pointer;
    transition: all 0.2s ease;
    min-height: 44px;
  }

  .btn-primary {
    background: var(--color-purple);
    color: var(--color-white);
  }

  .btn-primary:hover:not(:disabled) {
    background: var(--color-purple-dark);
    box-shadow: 0 4px 12px rgba(124, 58, 237, 0.3);
  }

  .btn-primary:disabled {
    background: var(--color-gray-4);
    cursor: not-allowed;
  }

  .btn-secondary {
    background: var(--color-white);
    color: var(--color-purple);
    border: 2px solid var(--color-purple);
  }

  .btn-secondary:hover {
    background: var(--color-purple-light);
  }

  /* Loading State */
  .loading-state {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: var(--space-3xl);
    text-align: center;
  }

  .loading-spinner {
    width: 60px;
    height: 60px;
    border: 4px solid var(--color-gray-3);
    border-top-color: var(--color-purple);
    border-radius: 50%;
    animation: spin 1s linear infinite;
    margin-bottom: var(--space-xl);
  }

  @keyframes spin {
    to { transform: rotate(360deg); }
  }

  .loading-state h2 {
    font-family: var(--font-heading);
    color: var(--color-purple);
    margin-bottom: var(--space-m);
  }

  .loading-state p {
    color: var(--color-gray-6);
  }

  /* Results Panel */
  .results-panel {
    padding: var(--space-xl);
  }

  .results-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: var(--space-xl);
    padding-bottom: var(--space-l);
    border-bottom: 2px solid var(--color-gray-2);
  }

  .results-header h2 {
    font-family: var(--font-display);
    font-size: var(--text-3xl);
    color: var(--color-purple);
    margin: 0;
  }

  .results-actions {
    display: flex;
    gap: var(--space-m);
  }

  .results-content {
    font-family: var(--font-body);
    line-height: 1.8;
    color: var(--color-gray-8);
  }

  @media (max-width: 768px) {
    .page-header h1 {
      font-size: var(--text-3xl);
    }

    .mode-selector {
      grid-template-columns: 1fr;
    }

    .metadata-grid {
      grid-template-columns: 1fr;
    }

    .results-header {
      flex-direction: column;
      align-items: flex-start;
      gap: var(--space-m);
    }

    .results-actions {
      flex-direction: column;
      width: 100%;
    }

    .btn-secondary {
      width: 100%;
      justify-content: center;
    }
  }
</style>
