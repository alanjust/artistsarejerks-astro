---
import HiddenGrammarLayout from '../../layouts/HiddenGrammarLayout.astro';
import { analysisModes, uiConfig } from '../../data/analysisModes.js';
import lensesData from '../../data/hg-lenses.json';

// Serialize mode data for client-side URL param resolution
const modesJSON = JSON.stringify(analysisModes);
const lensesJSON = JSON.stringify(lensesData);
---

<HiddenGrammarLayout
  title="AI Analysis — Hidden Grammar"
  description="Upload artwork and receive instant AI-powered analysis using the Hidden Grammar framework."
>
  <div class="hg-page hg-analyze-page">

    <!-- Breadcrumb (populated by JS) -->
    <nav class="hg-breadcrumb" id="analyzeBreadcrumb" aria-label="Breadcrumb">
      <a href="/hidden-grammar">Home</a>
      <span class="hg-breadcrumb-sep">›</span>
      <span id="breadcrumbMode">Select a mode</span>
      <span class="hg-breadcrumb-sep hg-breadcrumb-sep--prompt" id="breadcrumbSep2" style="display:none">›</span>
      <span id="breadcrumbPrompt" style="display:none"></span>
    </nav>

    <!-- Analysis context header (populated by JS) -->
    <div class="hg-analyze-header" id="analyzeHeader" style="display:none">
      <div class="hg-analyze-header-inner">
        <div>
          <p class="hg-analyze-mode-label" id="analyzeModeName"></p>
          <h1 class="hg-analyze-prompt-title" id="analyzePromptName"></h1>
          <p class="hg-analyze-submode-label" id="analyzeSubmodeName" style="display:none"></p>
        </div>
        <a href="#" id="backToModeLink" class="hg-btn hg-btn--ghost hg-back-btn">← Change prompt</a>
      </div>
    </div>

    <!-- No-params fallback header -->
    <div class="hg-page-header" id="fallbackHeader">
      <h1>Open Analysis</h1>
      <p>No pre-set prompt. Upload any image and write your own question or instruction in the Custom Prompt field below. For structured Hidden Grammar analysis, <a href="/hidden-grammar/toolkit" class="hg-inline-link">choose a mode from the Toolkit</a>.</p>
    </div>

    <!-- Analysis Form -->
    <div id="analysisForm" class="hg-analysis-form">

      <!-- Upload Section -->
      <section class="hg-form-section">
        <h2 class="hg-form-section-title">Upload Artwork</h2>

        <div class="upload-container">
          <div id="uploadArea" class="upload-area">
            <svg xmlns="http://www.w3.org/2000/svg" width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
              <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
              <polyline points="17 8 12 3 7 8"></polyline>
              <line x1="12" y1="3" x2="12" y2="15"></line>
            </svg>
            <p><strong>Click to upload</strong>, drag &amp; drop, or paste</p>
            <p class="upload-hint">JPG, PNG, WebP — or paste from clipboard — large images auto-optimized</p>
            <input type="file" id="imageInput" accept="image/*" hidden>
          </div>

          <div id="imagePreviewContainer" class="image-preview-container" style="display: none;">
            <img id="imagePreview" alt="Uploaded artwork">
            <button type="button" id="removeImage" class="btn-remove">Remove Image</button>
          </div>
        </div>
      </section>

      <!-- Dynamic Fields Section (populated by JS from URL params + mode data) -->
      <section class="hg-form-section" id="dynamicFieldsSection" style="display:none">
        <h2 class="hg-form-section-title">Artwork Details <span class="hg-optional-label">(optional)</span></h2>
        <div class="hg-fields-grid" id="dynamicFields">
          <!-- Fields injected by initPage() based on mode.fields -->
        </div>
      </section>

      <!-- No-mode fallback fields (shown when navigating directly without URL params) -->
      <section class="hg-form-section" id="fallbackFieldsSection">
        <h2 class="hg-form-section-title">Artwork Details <span class="hg-optional-label">(optional)</span></h2>
        <div class="hg-fields-grid">
          <div class="hg-field-group">
            <label class="hg-field-label" for="fallback_title">Title</label>
            <input class="hg-field-input" type="text" id="fallback_title" name="title" placeholder="e.g., Starry Night">
          </div>
          <div class="hg-field-group">
            <label class="hg-field-label" for="fallback_artist">Artist</label>
            <input class="hg-field-input" type="text" id="fallback_artist" name="artist" placeholder="e.g., Vincent van Gogh">
          </div>
          <div class="hg-field-group">
            <label class="hg-field-label" for="fallback_medium">Medium</label>
            <input class="hg-field-input" type="text" id="fallback_medium" name="medium" placeholder="e.g., Oil on canvas">
          </div>
          <div class="hg-field-group">
            <label class="hg-field-label" for="fallback_year">Year</label>
            <input class="hg-field-input" type="text" id="fallback_year" name="year" placeholder="e.g., 1889">
          </div>
        </div>
      </section>

      <!-- Additional Context / Custom Prompt Section -->
      <section class="hg-form-section" id="additionalContextSection">
        <h2 class="hg-form-section-title" id="additionalContextTitle">Additional Context <span class="hg-optional-label">(optional)</span></h2>
        <p class="hg-context-hint" id="additionalContextHint">Narrow the focus. Tell the AI what you're specifically trying to figure out — a question, a concern, a hunch. Gets appended to the prompt.</p>
        <textarea
          id="additionalContext"
          class="hg-field-textarea hg-context-textarea"
          rows="3"
          placeholder="e.g. I'm trying to understand why the spatial depth feels off, or whether the color temperature is working against the composition..."
        ></textarea>
      </section>

      <!-- Analyze Button -->
      <div class="hg-form-actions">
        <button type="button" class="hg-btn hg-btn--primary hg-analyze-btn" id="analyzeBtn" disabled>
          <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="m8 3 4 8 5-5 5 15H2L8 3z"></path>
          </svg>
          Analyze with AI
        </button>
      </div>
    </div>

    <!-- Loading State -->
    <div id="loadingState" class="hg-loading" style="display: none;">
      <div class="hg-loading-spinner"></div>
      <p class="hg-loading-text">Analyzing artwork...</p>
      <p class="hg-loading-sub">AI is examining the visual grammar</p>
    </div>

    <!-- Results Panel -->
    <div id="resultsPanel" class="hg-results-panel" style="display: none;">
      <div class="hg-results-header">
        <h2 class="hg-results-title">Analysis Results</h2>
        <button class="hg-btn hg-btn--ghost" id="backToForm">← New Analysis</button>
      </div>

      <!-- Main analysis output -->
      <div class="hg-results-body">
        <img id="resultThumbnail" class="hg-result-thumbnail" alt="Uploaded artwork" style="display:none">
        <div id="resultsContent" class="hg-results-content"></div>
        <div class="hg-copy-row" id="mainCopyRow">
          <button class="hg-btn hg-btn--copy" id="copyMainOutput">
            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
              <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
            </svg>
            Copy Analysis
          </button>
        </div>
      </div>

      <!-- Interrogation conversation (appended here) -->
      <div id="interrogationHistory" class="hg-interrogation-history"></div>

      <!-- Feedback widget (shown after analysis completes) -->
      <div id="feedbackWidget" class="hg-feedback-widget" style="display:none" aria-label="Analysis feedback">
        <div id="feedbackForm">
          <p class="hg-feedback-prompt">How useful was this analysis?</p>
          <div class="hg-feedback-stars" role="group" aria-label="Star rating">
            {[1, 2, 3, 4, 5].map(n => (
              <button
                type="button"
                class="hg-feedback-star"
                data-value={String(n)}
                aria-label={`${n} star${n > 1 ? 's' : ''}`}
                aria-pressed="false"
              >★</button>
            ))}
          </div>
          <textarea
            id="feedbackComment"
            class="hg-feedback-comment"
            rows={2}
            placeholder="Optional: what worked, what was confusing..."
          ></textarea>
          <button type="button" class="hg-btn hg-btn--ghost" id="feedbackSubmit">Send feedback</button>
        </div>
        <div id="feedbackThanks" class="hg-feedback-thanks" style="display:none">
          <p>Thanks — that helps.</p>
        </div>
      </div>

      <!-- Lens Modifier (shown after analysis completes) -->
      <div id="lensModifierSection" class="hg-lens-modifier" style="display:none">
        <h3 class="hg-lens-modifier-title">Apply a Lens</h3>
        <p class="hg-lens-modifier-hint">Re-read this image through a specific critical or philosophical framework. Each lens reshapes what's worth noticing without changing what's there.</p>
        <div class="hg-lens-modifier-controls">
          <select id="lensSelect" class="hg-lens-select">
            <option value="">Choose a lens...</option>
          </select>
          <button type="button" class="hg-btn hg-btn--secondary" id="applyLensBtn" disabled>Apply Lens</button>
        </div>
        <div id="lensLoading" class="hg-interrogation-loading" style="display:none">
          <div class="hg-loading-spinner hg-loading-spinner--sm"></div>
          <span>Applying lens...</span>
        </div>
      </div>

      <!-- Interrogation window -->
      <div id="interrogationWindow" class="hg-interrogation-window">
        <h3 class="hg-interrogation-title">Follow-up Questions</h3>
        <p class="hg-interrogation-hint">Ask a follow-up question about this analysis. The AI stays anchored to the visual evidence already identified.</p>
        <div class="hg-interrogation-form">
          <textarea
            id="interrogationInput"
            class="hg-interrogation-textarea"
            rows="3"
            placeholder={uiConfig.interrogationPlaceholder}
          ></textarea>
          <div class="hg-interrogation-actions">
            <button type="button" class="hg-btn hg-btn--secondary" id="interrogationSubmit">
              {uiConfig.interrogationSubmitLabel}
            </button>
          </div>
        </div>

        <!-- Loading indicator for interrogation -->
        <div id="interrogationLoading" class="hg-interrogation-loading" style="display:none">
          <div class="hg-loading-spinner hg-loading-spinner--sm"></div>
          <span>Thinking...</span>
        </div>
      </div>
    </div>

  </div>
</HiddenGrammarLayout>

<!-- Embed mode data for client-side resolution -->
<script type="application/json" id="analysisModesData" set:html={modesJSON}></script>
<!-- Embed lenses data for lens modifier -->
<script type="application/json" id="lensesData" set:html={lensesJSON}></script>

<script>
  import '../../scripts/ai-analyze/index';
</script>

<style>
  .hg-analyze-page {
    max-width: 860px;
  }

  /* ── Context header ───────────────────────── */
  .hg-analyze-header {
    background: #eef2ff;
    border: 1px solid #c7d2fe;
    border-radius: 12px;
    padding: 1.25rem 1.5rem;
    margin-bottom: 1.5rem;
  }

  .hg-analyze-header-inner {
    display: flex;
    align-items: flex-start;
    justify-content: space-between;
    gap: 1rem;
    flex-wrap: wrap;
  }

  .hg-analyze-mode-label {
    font-size: 0.75rem;
    font-weight: 600;
    letter-spacing: 0.06em;
    text-transform: uppercase;
    color: #6366f1;
    margin: 0 0 0.25rem 0;
  }

  .hg-analyze-prompt-title {
    font-size: 1.25rem;
    font-weight: 700;
    color: #1e293b;
    margin: 0;
    line-height: 1.3;
  }

  .hg-analyze-submode-label {
    font-size: 0.875rem;
    color: #6366f1;
    margin: 0.25rem 0 0 0;
    font-weight: 500;
  }

  .hg-back-btn {
    flex-shrink: 0;
    font-size: 0.875rem;
  }

  .hg-inline-link {
    color: #4f46e5;
    text-decoration: underline;
  }

  /* ── Form sections ────────────────────────── */
  .hg-analysis-form {
    background: #ffffff;
    border: 1px solid #e2e8f0;
    border-radius: 16px;
    overflow: hidden;
  }

  .hg-form-section {
    padding: 1.75rem 2rem;
    border-bottom: 1px solid #f1f5f9;
  }

  .hg-form-section:last-of-type {
    border-bottom: none;
  }

  .hg-form-section-title {
    font-size: 1rem;
    font-weight: 700;
    color: #1e293b;
    margin: 0 0 1.25rem 0;
  }

  .hg-optional-label {
    font-size: 0.8125rem;
    font-weight: 400;
    color: #94a3b8;
  }

  /* ── Upload area ──────────────────────────── */
  .upload-area {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    gap: 0.5rem;
    padding: 2.5rem 2rem;
    border: 2px dashed #cbd5e1;
    border-radius: 12px;
    background: #f8fafc;
    cursor: pointer;
    transition: all 0.15s ease;
    min-height: 180px;
    text-align: center;
  }

  .upload-area:hover,
  .upload-area.dragover {
    border-color: #4f46e5;
    background: #eef2ff;
  }

  .upload-area svg {
    color: #94a3b8;
    flex-shrink: 0;
  }

  .upload-area:hover svg,
  .upload-area.dragover svg {
    color: #4f46e5;
  }

  .upload-area p {
    margin: 0;
    color: #64748b;
    font-size: 0.9375rem;
  }

  .upload-hint {
    font-size: 0.8125rem !important;
    color: #94a3b8 !important;
  }

  .image-preview-container {
    position: relative;
    border-radius: 12px;
    overflow: hidden;
    background: #f8fafc;
    border: 1px solid #e2e8f0;
  }

  .image-preview-container img {
    width: 100%;
    max-height: 500px;
    object-fit: contain;
    display: block;
  }

  .btn-remove {
    position: absolute;
    top: 0.75rem;
    right: 0.75rem;
    background: rgba(15, 23, 42, 0.75);
    color: #ffffff;
    border: none;
    padding: 0.375rem 0.875rem;
    border-radius: 6px;
    cursor: pointer;
    font-size: 0.875rem;
    font-weight: 600;
    font-family: inherit;
    transition: background 0.15s ease;
  }

  .btn-remove:hover {
    background: rgba(15, 23, 42, 0.9);
  }

  /* ── Dynamic fields ───────────────────────── */
  .hg-fields-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(min(100%, 240px), 1fr));
    gap: 1rem;
  }

  .hg-field-group {
    display: flex;
    flex-direction: column;
    gap: 0.375rem;
  }

  .hg-field-group.full-width {
    grid-column: 1 / -1;
  }

  .hg-field-label {
    font-size: 0.875rem;
    font-weight: 600;
    color: #374151;
  }

  .hg-field-input,
  .hg-field-textarea {
    width: 100%;
    padding: 0.5625rem 0.75rem;
    border: 1.5px solid #e2e8f0;
    border-radius: 8px;
    font-size: 0.9375rem;
    font-family: inherit;
    color: #1e293b;
    background: #ffffff;
    transition: border-color 0.15s ease;
  }

  .hg-field-input:focus,
  .hg-field-textarea:focus {
    outline: none;
    border-color: #4f46e5;
    box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
  }

  .hg-field-textarea {
    resize: vertical;
    min-height: 96px;
    line-height: 1.5;
  }

  /* ── Additional context ────────────────────── */
  .hg-context-hint {
    font-size: 0.875rem;
    color: #94a3b8;
    margin: 0 0 0.875rem 0;
    line-height: 1.55;
  }

  .hg-context-textarea {
    width: 100%;
  }

  /* ── Analyze button ───────────────────────── */
  .hg-form-actions {
    padding: 1.5rem 2rem;
    display: flex;
    justify-content: flex-start;
  }

  .hg-analyze-btn {
    padding: 0.75rem 2rem;
    font-size: 1rem;
    gap: 0.625rem;
  }

  /* ── Loading ──────────────────────────────── */
  .hg-loading {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: 4rem 2rem;
    text-align: center;
  }

  .hg-loading-spinner {
    width: 48px;
    height: 48px;
    border: 3px solid #e2e8f0;
    border-top-color: #4f46e5;
    border-radius: 50%;
    animation: hg-spin 0.9s linear infinite;
    margin-bottom: 1.25rem;
  }

  .hg-loading-spinner--sm {
    width: 20px;
    height: 20px;
    border-width: 2px;
    margin-bottom: 0;
  }

  @keyframes hg-spin {
    to { transform: rotate(360deg); }
  }

  .hg-loading-text {
    font-size: 1.125rem;
    font-weight: 600;
    color: #1e293b;
    margin: 0 0 0.25rem 0;
  }

  .hg-loading-sub {
    font-size: 0.9375rem;
    color: #94a3b8;
    margin: 0;
  }

  /* ── Results ──────────────────────────────── */
  .hg-results-panel {
    background: #ffffff;
    border: 1px solid #e2e8f0;
    border-radius: 16px;
    overflow: hidden;
  }

  .hg-results-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 1rem;
    padding: 1.25rem 1.75rem;
    border-bottom: 1px solid #f1f5f9;
    flex-wrap: wrap;
  }

  .hg-results-title {
    font-size: 1.125rem;
    font-weight: 700;
    color: #1e293b;
    margin: 0;
  }

  .hg-results-body {
    padding: 1.75rem;
    border-bottom: 1px solid #f1f5f9;
  }

  .hg-results-content {
    font-size: 0.9375rem;
    line-height: 1.8;
    color: #1e293b;
  }

  /* Markdown output styles */
  .hg-results-content h1,
  .hg-results-content h2,
  .hg-results-content h3,
  .hg-results-content h4 {
    color: #1e293b;
    margin-top: 1.5em;
    margin-bottom: 0.5em;
    line-height: 1.3;
  }

  .hg-results-content h1 { font-size: 1.375rem; }
  .hg-results-content h2 { font-size: 1.1875rem; border-bottom: 1px solid #f1f5f9; padding-bottom: 0.5rem; }
  .hg-results-content h3 { font-size: 1.0625rem; }
  .hg-results-content h4 { font-size: 0.9375rem; color: #475569; }

  .hg-results-content p { margin: 0.75em 0; }
  .hg-results-content ul, .hg-results-content ol { padding-left: 1.5em; margin: 0.75em 0; }
  .hg-results-content li { margin: 0.375em 0; }

  .hg-results-content table {
    width: 100%;
    border-collapse: collapse;
    font-size: 0.875rem;
    margin: 1em 0;
    overflow-x: auto;
    display: block;
  }

  .hg-results-content th,
  .hg-results-content td {
    border: 1px solid #e2e8f0;
    padding: 0.5rem 0.75rem;
    text-align: left;
  }

  .hg-results-content th {
    background: #f8fafc;
    font-weight: 600;
    color: #374151;
  }

  .hg-results-content blockquote {
    border-left: 3px solid #c7d2fe;
    padding: 0.25rem 1rem;
    margin: 1em 0;
    color: #64748b;
    background: #f8fafc;
    border-radius: 0 8px 8px 0;
  }

  .hg-results-content code {
    background: #f1f5f9;
    padding: 0.125em 0.375em;
    border-radius: 4px;
    font-size: 0.875em;
  }

  .hg-results-content strong { color: #1e293b; }
  .hg-results-content hr { border: none; border-top: 1px solid #e2e8f0; margin: 1.5em 0; }

  /* ── Result thumbnail ─────────────────────── */
  .hg-result-thumbnail {
    float: right;
    max-width: 120px;
    width: 120px;
    height: auto;
    border-radius: 8px;
    border: 1px solid #e2e8f0;
    margin: 0 0 1rem 1.5rem;
    display: block;
  }

  @media (max-width: 640px) {
    .hg-result-thumbnail {
      float: none;
      width: 80px;
      margin: 0 0 1rem 0;
    }
  }

  .hg-copy-row {
    display: flex;
    justify-content: flex-end;
    padding-top: 1rem;
    margin-top: 1rem;
    border-top: 1px solid #f1f5f9;
  }

  /* ── Interrogation history ────────────────── */
  .hg-interrogation-history {
    /* Individual turns appended here by JS */
  }

  .hg-interrogation-turn {
    border-top: 1px solid #f1f5f9;
  }

  .hg-interrogation-question {
    padding: 1rem 1.75rem;
    background: #f8fafc;
    border-bottom: 1px solid #f1f5f9;
  }

  .hg-interrogation-question p {
    margin: 0;
    font-size: 0.9375rem;
    color: #374151;
  }

  .hg-interrogation-question-label {
    font-size: 0.75rem;
    font-weight: 600;
    letter-spacing: 0.05em;
    text-transform: uppercase;
    color: #94a3b8;
    margin: 0 0 0.375rem 0;
  }

  .hg-interrogation-answer {
    padding: 1.25rem 1.75rem;
  }

  .hg-interrogation-answer-content {
    font-size: 0.9375rem;
    line-height: 1.8;
    color: #1e293b;
  }

  /* Inherit markdown styles for interrogation answers */
  .hg-interrogation-answer-content h2,
  .hg-interrogation-answer-content h3 {
    color: #1e293b;
    margin-top: 1.25em;
    margin-bottom: 0.4em;
  }

  .hg-interrogation-answer-content p { margin: 0.625em 0; }
  .hg-interrogation-answer-content ul { padding-left: 1.5em; margin: 0.5em 0; }

  /* ── Interrogation window ─────────────────── */
  .hg-interrogation-window {
    padding: 1.5rem 1.75rem;
    background: #fafbff;
    border-top: 1px solid #e2e8f0;
  }

  .hg-interrogation-title {
    font-size: 1rem;
    font-weight: 700;
    color: #1e293b;
    margin: 0 0 0.25rem 0;
  }

  .hg-interrogation-hint {
    font-size: 0.875rem;
    color: #94a3b8;
    margin: 0 0 1rem 0;
  }

  .hg-interrogation-form {
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
  }

  .hg-interrogation-textarea {
    width: 100%;
    padding: 0.625rem 0.875rem;
    border: 1.5px solid #e2e8f0;
    border-radius: 8px;
    font-size: 0.9375rem;
    font-family: inherit;
    color: #1e293b;
    resize: vertical;
    line-height: 1.5;
    transition: border-color 0.15s ease;
  }

  .hg-interrogation-textarea:focus {
    outline: none;
    border-color: #4f46e5;
    box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.08);
  }

  .hg-interrogation-actions {
    display: flex;
    align-items: center;
    gap: 0.75rem;
  }

  .hg-interrogation-loading {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-size: 0.875rem;
    color: #94a3b8;
    margin-top: 0.75rem;
  }

  /* ── Feedback widget ────────────────────────── */
  .hg-feedback-widget {
    padding: 1.25rem 1.75rem;
    border-top: 1px solid #f1f5f9;
    background: #fafbff;
  }

  .hg-feedback-prompt {
    font-size: 0.9375rem;
    font-weight: 600;
    color: #374151;
    margin: 0 0 0.75rem 0;
  }

  .hg-feedback-stars {
    display: flex;
    gap: 0.125rem;
    margin-bottom: 0.875rem;
  }

  .hg-feedback-star {
    background: none;
    border: none;
    font-size: 1.625rem;
    cursor: pointer;
    color: #cbd5e1;
    padding: 0.125rem 0.25rem;
    line-height: 1;
    transition: color 0.1s ease, transform 0.1s ease;
    font-family: inherit;
  }

  .hg-feedback-star:hover,
  .hg-feedback-star--hover {
    color: #f59e0b;
    transform: scale(1.2);
  }

  .hg-feedback-star--active {
    color: #f59e0b;
  }

  .hg-feedback-comment {
    width: 100%;
    padding: 0.5625rem 0.75rem;
    border: 1.5px solid #e2e8f0;
    border-radius: 8px;
    font-size: 0.9375rem;
    font-family: inherit;
    color: #1e293b;
    resize: vertical;
    line-height: 1.5;
    margin-bottom: 0.75rem;
    transition: border-color 0.15s ease;
    box-sizing: border-box;
  }

  .hg-feedback-comment:focus {
    outline: none;
    border-color: #4f46e5;
    box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.08);
  }

  .hg-feedback-thanks p {
    margin: 0;
    font-size: 0.9375rem;
    color: #64748b;
  }

  /* ── Lens modifier ────────────────────────── */
  .hg-lens-modifier {
    padding: 1.5rem 1.75rem;
    border-top: 1px solid #e2e8f0;
    background: #f8fafc;
  }

  .hg-lens-modifier-title {
    font-size: 1rem;
    font-weight: 700;
    color: #1e293b;
    margin: 0 0 0.25rem 0;
  }

  .hg-lens-modifier-hint {
    font-size: 0.875rem;
    color: #94a3b8;
    margin: 0 0 1rem 0;
    line-height: 1.55;
  }

  .hg-lens-modifier-controls {
    display: flex;
    gap: 0.75rem;
    align-items: center;
    flex-wrap: wrap;
  }

  .hg-lens-select {
    flex: 1;
    min-width: 200px;
    padding: 0.5625rem 0.75rem;
    border: 1.5px solid #e2e8f0;
    border-radius: 8px;
    font-size: 0.9375rem;
    font-family: inherit;
    color: #1e293b;
    background: #ffffff;
    transition: border-color 0.15s ease;
    appearance: auto;
  }

  .hg-lens-select:focus {
    outline: none;
    border-color: #4f46e5;
    box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.08);
  }

  /* ── Lens turns (in interrogation history) ── */
  .hg-lens-turn .hg-lens-turn-header {
    display: flex;
    align-items: baseline;
    gap: 0.625rem;
    flex-wrap: wrap;
    padding: 0.875rem 1.75rem;
    background: #f0fdf4;
    border-bottom: 1px solid #bbf7d0;
  }

  .hg-lens-turn-label {
    font-size: 0.6875rem;
    font-weight: 700;
    letter-spacing: 0.07em;
    text-transform: uppercase;
    color: #16a34a;
  }

  .hg-lens-turn-name {
    font-size: 0.9375rem;
    font-weight: 700;
    color: #1e293b;
  }

  .hg-lens-turn-thinker {
    font-size: 0.8125rem;
    color: #64748b;
    font-style: italic;
  }

  /* Mobile */
  @media (max-width: 640px) {
    .hg-form-section {
      padding: 1.25rem 1rem;
    }

    .hg-form-actions {
      padding: 1.25rem 1rem;
    }

    .hg-results-body,
    .hg-interrogation-window,
    .hg-results-header {
      padding-left: 1rem;
      padding-right: 1rem;
    }

    .hg-interrogation-question,
    .hg-interrogation-answer {
      padding-left: 1rem;
      padding-right: 1rem;
    }

    .hg-feedback-widget,
    .hg-lens-modifier {
      padding-left: 1rem;
      padding-right: 1rem;
    }

    .hg-fields-grid {
      grid-template-columns: 1fr;
    }
  }
</style>
